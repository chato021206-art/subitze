<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>SNOW: SMASH SUBITIZING - FERMATA AESTHETIC</title>
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&family=Noto+Sans+JP:wght@900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-dark: #050505;
    --g-exc: #fff200;  --g-perf: #00ffff; --g-grt: #00ff2a;
    --g-good: #ffaa00; --g-ok:   #b0b0b0; --g-miss: #ff0033;
    --c-easy: #55ff33; --c-normal: #00aaff; --c-hard: #ffcc00; --c-extreme: #ff0022; --c-random: #d000ff;
    
    /* FERMATA COLORS */
    --f-warm-border: rgba(170, 153, 136, 0.6); /* „Ç∞„É¨„Éº„Ç∏„É•„ÅÆÊû† */
    --f-warm-bg: rgba(40, 36, 32, 0.85);       /* Êöñ„Åã„Åø„ÅÆ„ÅÇ„Çã„ÉÄ„Éº„ÇØ„Ç∞„É¨„Éº */
    --f-icon-active: #EEDDCC;                  /* Êöñ„Åã„Åø„ÅÆ„ÅÇ„ÇãÁôΩÔºà„Éú„Éº„É≥„Éõ„ÉØ„Ç§„ÉàÔºâ */
    
    --f-cool-bg: rgba(20, 22, 25, 0.4);        /* ÈÄöÂ∏∏‰∏ñÁïå„Çà„ÇäÂ∞ë„ÅóÂÜ∑„Åü„ÅÑËÉåÊôØ */
    --f-icon-cesura: #9A9A9A;                  /* ÂÜ∑„Åü„ÅÑ„Éã„É•„Éº„Éà„É©„É´„Ç∞„É¨„Éº */

    --font-ui: 'Montserrat', 'Noto Sans JP', sans-serif;
    --font-num: 'Montserrat', sans-serif;
    --block-size-base: min(7.5vw, 30px);
    --block-size-2d: var(--block-size-base);
    --block-size-3d: calc(var(--block-size-base) * 1.1);
    --kb-height: clamp(200px, 33dvh, 320px);
    --footer-base-height: 80px;
    --safe-area-bottom: env(safe-area-inset-bottom, 0px);
    --footer-total-height: calc(var(--footer-base-height) + var(--safe-area-bottom));
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body {
    font-family: var(--font-ui); background-color: var(--bg-dark); color: #fff; margin: 0; padding: 0;
    display: flex; flex-direction: column; height: 100dvh; width: 100%; overflow: hidden; position: fixed; user-select: none;
    background-image: linear-gradient(45deg, #1a1a1a 25%, transparent 25%, transparent 75%, #1a1a1a 75%, #1a1a1a), linear-gradient(45deg, #1a1a1a 25%, transparent 25%, transparent 75%, #1a1a1a 75%, #1a1a1a);
    background-size: 30px 30px; background-position: 0 0, 15px 15px;
  }
  
  /* --- FERMATAÔºà„Çπ„É≠„Éº„É¢„Éº„Ç∑„Éß„É≥ÔºâÊºîÂá∫ --- */
  body.slow-motion .app-container {
    filter: sepia(80%) contrast(1.1);
    transform: scale(1.01);
    transition: filter 1s ease-out, transform 13s ease-out;
  }
  
  /* „Éï„Ç©„Ç∞ÊºîÂá∫ */
  #slow-overlay-fx {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 4000;
    background: radial-gradient(circle, transparent 40%, rgba(180, 140, 0, 0.2) 100%);
    opacity: 0; transition: opacity 1s; mix-blend-mode: screen;
  }
  body.slow-motion #slow-overlay-fx { opacity: 1; }

  .app-container {
    width: 100%; height: 100%; max-width: 600px; margin: 0 auto; display: flex; flex-direction: column;
    padding: 8px; padding-top: env(safe-area-inset-top, 8px); background: radial-gradient(circle at center, #2a2a2a 0%, #000 100%);
    position: relative; z-index: 1; transition: background 0.3s; box-shadow: 0 0 50px rgba(0,0,0,0.8);
  }
  .app-container.theme-easy { background: radial-gradient(circle at center, rgba(85, 255, 51, 0.15) 0%, #000 100%); }
  .app-container.theme-normal { background: radial-gradient(circle at center, rgba(0, 170, 255, 0.15) 0%, #000 100%); }
  .app-container.theme-hard { background: radial-gradient(circle at center, rgba(255, 204, 0, 0.15) 0%, #000 100%); }
  .app-container.theme-extreme { background: radial-gradient(circle at center, rgba(255, 0, 34, 0.15) 0%, #000 100%); }
  .app-container.showing-result .stage-area { visibility: hidden; }

  .stage-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; position: relative; overflow: hidden; perspective: 900px; min-height: 0; }
  .version-label { position: absolute; bottom: 6px; right: 8px; font-size: 10px; font-weight: 900; color: rgba(255,255,255,0.4); font-family: var(--font-num); pointer-events: none; z-index: 100; font-style: italic; }

  /* Slot Styles */
  .app-container.theme-easy #slot-1 { box-shadow: 0 0 25px rgba(85, 255, 51, 0.4); border: 2px solid rgba(85, 255, 51, 0.3); }
  .app-container.theme-normal #slot-1 { box-shadow: 0 0 25px rgba(0, 170, 255, 0.4); border: 2px solid rgba(0, 170, 255, 0.3); }
  .app-container.theme-hard #slot-1 { background: rgba(255, 204, 0, 0.05); box-shadow: 0 0 25px rgba(255, 204, 0, 0.4); border: 2px solid rgba(255, 204, 0, 0.3); flex: 1; }
  .app-container.theme-hard #slot-2 { flex: 1 !important; opacity: 0.8; border-right: 1px dashed rgba(255,255,255,0.2); }
  .app-container.theme-hard #slot-3 { display: none !important; }
  .app-container.theme-extreme #slot-1 { flex: 100; border: 4px solid var(--c-extreme); background: rgba(50, 0, 0, 0.3); justify-content: flex-end; align-items: center; box-shadow: 0 0 40px rgba(255, 0, 34, 0.6), inset 0 0 20px rgba(255, 0, 34, 0.2); }
  .app-container.theme-extreme #slot-2, .app-container.theme-extreme #slot-3 { display: none !important; }
  
  .slot-flash-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; opacity: 0; transform-origin: bottom; }
  .flash-exc .slot-flash-overlay { background: linear-gradient(to top, rgba(255, 242, 0, 0.8) 0%, transparent 100%); animation: flashBeam 0.2s ease-out forwards; }
  .flash-perf .slot-flash-overlay { background: linear-gradient(to top, rgba(0, 255, 255, 0.8) 0%, transparent 100%); animation: flashBeam 0.2s ease-out forwards; }
  .flash-grt .slot-flash-overlay { background: linear-gradient(to top, rgba(0, 255, 42, 0.7) 0%, transparent 100%); animation: flashBeam 0.2s ease-out forwards; }
  .flash-good .slot-flash-overlay { background: linear-gradient(to top, rgba(255, 170, 0, 0.7) 0%, transparent 100%); animation: flashBeam 0.2s ease-out forwards; }
  .flash-ok .slot-flash-overlay { background: linear-gradient(to top, rgba(176, 176, 176, 0.7) 0%, transparent 100%); animation: flashBeam 0.2s ease-out forwards; }
  .flash-miss .slot-flash-overlay { background: linear-gradient(to top, rgba(255, 0, 51, 0.9) 0%, transparent 100%); animation: flashBeam 0.3s ease-out forwards; }
  @keyframes flashBeam { 0% { opacity: 1; height: 10%; } 100% { opacity: 0; height: 100%; } }

  #fail-shutter { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: repeating-linear-gradient(45deg, #111, #111 20px, #000 20px, #000 40px), linear-gradient(to bottom, rgba(255,0,0,0.2), #000); background-blend-mode: overlay; display: flex; align-items: center; justify-content: center; transform: translateY(-100%); z-index: 5500; pointer-events: none; transition: transform 0.2s; box-shadow: 0 10px 50px rgba(0,0,0,1); border-bottom: 10px solid #222; }
  #fail-shutter.active { transform: translateY(0); pointer-events: auto; }
  #victory-shutter { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: linear-gradient(to top, rgba(255,255,255,1) 0%, rgba(255,255,255,0.8) 20%, rgba(255,255,255,0) 100%); z-index: 5500; pointer-events: none; display: flex; align-items: flex-end; justify-content: center; transition: height 0.4s; backdrop-filter: blur(4px); }
  #victory-shutter.active { height: 100%; pointer-events: auto; animation: beamPulse 0.8s ease-out forwards; }
  @keyframes beamPulse { 0% { opacity: 0; height: 0%; } 30% { opacity: 1; height: 100%; background: linear-gradient(to top, rgba(255,255,255,1) 0%, rgba(0, 170, 255, 0.5) 50%, rgba(0,0,0,0) 100%); } 100% { opacity: 0; height: 100%; background: transparent; } }

  .mode-label { position: absolute; top: 15px; right: 15px; font-size: 14px; font-weight: 900; font-style: italic; letter-spacing: -1px; padding: 6px 30px; transform: skewX(-15deg); background: #000; color: #fff; z-index: 90; display: none; text-transform: uppercase; box-shadow: 6px 6px 0 rgba(0,0,0,0.5); border: 4px solid currentColor; text-shadow: 1px 1px 0 #000; }
  .mode-label.show { display: block; }

  #btn-mode-toggle { position: absolute; top: 60px; right: 15px; pointer-events: auto; background: #222; border: 3px solid #555; color: #ddd; border-radius: 4px; padding: 6px 14px; font-family: var(--font-ui); font-weight: 900; font-size: 12px; font-style: italic; cursor: pointer; z-index: 5100; display: flex; align-items: center; gap: 8px; transition: all 0.1s; transform: skewX(-10deg); box-shadow: 4px 4px 0 rgba(0,0,0,0.8); letter-spacing: -0.5px; }
  #btn-mode-toggle span.check { font-size: 16px; color: #999; font-weight: 900; }
  #btn-mode-toggle:active { transform: skewX(-10deg) translateY(2px); box-shadow: 1px 1px 0 rgba(0,0,0,0.8); }
  #btn-mode-toggle.random-on { background: #330033; border-color: #d000ff; color: #fff; box-shadow: 0 0 15px rgba(208, 0, 255, 0.4); }

  /* „ÉÑ„Éº„É´„Éê„Éº */
  #kb-toolbar { 
      width: 100%; display: flex; justify-content: space-between; 
      align-items: flex-end; padding: 0 10px; margin-bottom: 8px; z-index: 3001; position: relative; pointer-events: none; 
  }
  
  #btn-key-layout-toggle { pointer-events: auto; background: #000; border: 3px solid #444; color: #ddd; border-radius: 4px; padding: 4px 16px; font-family: var(--font-ui); font-weight: 900; font-size: 11px; font-style: italic; cursor: pointer; text-transform: uppercase; box-shadow: 4px 4px 0 rgba(0,0,0,0.8); letter-spacing: 0.5px; transform: skewX(-10deg); transform-origin: bottom left; transition: all 0.2s; display: flex; margin-right: auto; }
  #btn-key-layout-toggle:active { transform: skewX(-10deg) translateY(2px); filter: brightness(1.2); box-shadow: 1px 1px 0 rgba(0,0,0,0.8); }
  
  /* FERMATA„Éú„Çø„É≥ (Aesthetic) */
  #btn-slow-mo { 
      pointer-events: auto; 
      border-radius: 4px; padding: 0px 8px; 
      font-family: var(--font-ui); font-weight: 900; font-style: italic; cursor: pointer; text-transform: uppercase; 
      box-shadow: 4px 4px 0 rgba(0,0,0,0.8); transform: skewX(-10deg); transform-origin: bottom left; 
      display: none; align-items: center; justify-content: center; transition: all 0.2s; min-width: 80px; height: 36px;
      margin-left: auto; 
      
      /* „Éá„Éï„Ç©„É´„Éà(Ready) */
      background: var(--f-warm-bg);
      border: 2px solid var(--f-warm-border);
      color: var(--f-icon-active);
  }
  #btn-slow-mo:active { transform: skewX(-10deg) translateY(2px); box-shadow: 1px 1px 0 rgba(0,0,0,0.8); }
  
  /* ÊûØÊ∏áÁä∂ÊÖã (//) - Êû†Á∑öÊ∂àÂéª„ÄÅËÉåÊôØÂÜ∑Ëâ≤ */
  #btn-slow-mo.depleted { 
      background: var(--f-cool-bg);
      border: 2px solid transparent; /* Êû†Á∑ö„ÇíÊ∂à„Åô */
      box-shadow: none;
      pointer-events: none;
      filter: none;
  }
  
  /* Áô∫Âãï‰∏≠ (Running) - Âπ≤Ê∏â‰∏çÂèØ */
  #btn-slow-mo.running {
      opacity: 0.7;
      pointer-events: none; /* Êäº„Åõ„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã */
      filter: brightness(0.8);
      border-color: rgba(255,255,255,0.2);
  }

  /* „Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */
  .ts-charge-container { display: flex; gap: 6px; justify-content: center; width: 100%; align-items: center; } 
  .ts-charge-icon { 
      font-size: 36px; font-weight: 400; text-shadow: 0 0 5px rgba(238, 221, 204, 0.3);
      color: var(--f-icon-active);
      display: inline-block; text-align: center; line-height: 0.8; letter-spacing: -4px;
  }
  /* „Ç´„Ç®„Çπ„Éº„É© (#9A9A9A) */
  .ts-charge-icon.used-cesura { 
      color: var(--f-icon-cesura); 
      text-shadow: none; 
      font-size: 24px; letter-spacing: 2px; font-weight: 900; font-style: italic; font-family: monospace;
  }
  
  .btn-color-a { border-color: #00ccff !important; color: #00ccff !important; text-shadow: 0 0 5px rgba(0, 204, 255, 0.5); background: linear-gradient(to top, rgba(0, 204, 255, 0.1), #000) !important; }
  .btn-color-b { border-color: #33ff55 !important; color: #33ff55 !important; text-shadow: 0 0 5px rgba(51, 255, 85, 0.5); background: linear-gradient(to top, rgba(51, 255, 85, 0.1), #000) !important; }
  .btn-color-c { border-color: #ff8800 !important; color: #ff8800 !important; text-shadow: 0 0 5px rgba(255, 136, 0, 0.5); background: linear-gradient(to top, rgba(255, 136, 0, 0.1), #000) !important; }

  .btn-how-to-common { position: absolute; pointer-events: auto; background: #004488; border: 3px solid #00aaff; color: #fff; border-radius: 4px; padding: 6px 14px; font-family: var(--font-ui); font-weight: 900; font-size: 12px; font-style: italic; cursor: pointer; z-index: 5100; display: flex; align-items: center; gap: 6px; transition: all 0.1s; transform: skewX(-10deg); box-shadow: 4px 4px 0 rgba(0,0,0,0.8); letter-spacing: -0.5px; text-shadow: 1px 1px 0 #000; }
  #btn-how-to-opening { top: 60px; left: 15px; }
  #btn-how-to-bottom { bottom: calc(var(--footer-total-height) - 10px); left: 15px; width: auto; z-index: 3200; display: none; top:auto; }

  #conveyor-wrapper { width: 100%; height: 100%; display: flex; align-items: flex-end; justify-content: center; gap: 8px; padding: 2vh 2vw 0 2vw; transform-style: preserve-3d; pointer-events: none; }
  .slot { flex: 1; height: calc(100% - 2vh); display: flex; flex-direction: column; align-items: center; justify-content: flex-end; position: relative; transform-style: preserve-3d; background: rgba(20,20,20,0.6); border-radius: 4px 4px 0 0; border: 2px solid rgba(255,255,255,0.1); border-bottom: none; transition: flex 0.3s, opacity 0.3s; overflow: hidden; }
  #slot-1 { background: rgba(50,50,50,0.2); border: none; z-index: 10; position: relative; }
  .slot-timer-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; overflow: visible; filter: drop-shadow(0 0 5px currentColor); }
  .timer-path { fill: none; stroke-linecap: butt; stroke-linejoin: round; transition: stroke 0.1s linear; }

  .cluster-container { display: flex; align-items: flex-end; gap: 3px; padding-bottom: 12px; transform-style: preserve-3d; transition: transform 0.1s; }
  .block-column { display: flex; flex-direction: column-reverse; gap: 3px; width: var(--block-size-2d); transform-style: preserve-3d; }
  .block { width: var(--block-size-2d); height: var(--block-size-2d); border-radius: 2px; box-shadow: inset 3px 3px 0 rgba(255,255,255,0.5), inset -3px -3px 0 rgba(0,0,0,0.4), 3px 3px 5px rgba(0,0,0,0.6); border: 1px solid rgba(0,0,0,0.5); position: relative; }
  .cluster-container.random-layout { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: block; padding: 0; }
  .block.block-random { position: absolute; z-index: 10; }
  .block.mode-easy { background: var(--c-easy); } .block.mode-normal { background: var(--c-normal); } .block.mode-hard { background: var(--c-hard); } .block.mode-extreme { background: var(--c-extreme); border: 1px solid #500; }
  .cluster-container.real-3d { position: absolute; bottom: 10%; transform-style: preserve-3d; transform: rotateX(-20deg) rotateY(25deg); }
  .cube { width: var(--block-size-3d); height: var(--block-size-3d); position: absolute; transform-style: preserve-3d; }
  .face { position: absolute; width: 100%; height: 100%; border: 2px solid rgba(0,0,0,0.6); opacity: 1; }
  .face-front { transform: translateZ(calc(var(--block-size-3d)/2)); }
  .face-back { transform: rotateY(180deg) translateZ(calc(var(--block-size-3d)/2)); }
  .face-right { transform: rotateY(90deg) translateZ(calc(var(--block-size-3d)/2)); }
  .face-left { transform: rotateY(-90deg) translateZ(calc(var(--block-size-3d)/2)); }
  .face-top { transform: rotateX(90deg) translateZ(calc(var(--block-size-3d)/2)); filter: brightness(1.3); border: 1px solid rgba(255,255,255,0.5); }
  .face-bottom { transform: rotateX(-90deg) translateZ(calc(var(--block-size-3d)/2)); filter: brightness(0.5); }
  .cube.mode-easy .face { background: var(--c-easy); } .cube.mode-normal .face { background: var(--c-normal); } .cube.mode-hard .face { background: var(--c-hard); } .cube.mode-extreme .face { background: var(--c-extreme); }

  .virtual-keyboard { position: relative; width: 100%; height: var(--kb-height); background: linear-gradient(150deg, #0a0a0a 0%, #151515 100%); padding: 6px; padding-bottom: max(6px, var(--safe-area-bottom)); display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(4, 1fr); gap: 5px; z-index: 3000; border-top: 4px solid #333; pointer-events: auto; box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.8); }
  .virtual-keyboard::before { content: ''; position: absolute; top:0; left:0; width:100%; height:100%; background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.03) 0, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 10px); pointer-events: none; }
  .virtual-keyboard.layout-phone { grid-template-areas: "k1 k2 k3" "k4 k5 k6" "k7 k8 k9" "ver k0 del"; }
  .virtual-keyboard.layout-calc { grid-template-areas: "k7 k8 k9" "k4 k5 k6" "k1 k2 k3" "ver k0 del"; }
  .virtual-keyboard.layout-special { grid-template-areas: "k0 k1 k2" "k3 k4 ver" "k5 k6 del" "k7 k8 k9"; }
  .kb-key { background: linear-gradient(to bottom, #2a2a2a, #111); border-radius: 6px; border: 2px solid #444; box-shadow: 0 4px 0 #000, inset 0 2px 0 rgba(255,255,255,0.1); color: #ccc; font-family: var(--font-num); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; touch-action: manipulation; overflow: hidden; transition: all 0.05s; }
  .kb-key:active, .kb-key.active-state { transform: translateY(4px); box-shadow: 0 0 0 #000; background: linear-gradient(to bottom, #ffcc00, #ff9900); color: #000; border-color: #fff; }
  .kb-key-main { font-size: clamp(24px, 5vh, 36px); font-weight: 900; font-style: italic; text-shadow: 2px 2px 0 #000; letter-spacing: -2px; }
  .kb-key.disabled { opacity: 0.15; pointer-events: none; box-shadow: none; border-color: #222; background: #000; }
  .kb-key.ripple::after { content: ''; position: absolute; inset: 0; background: rgba(255,255,255,0.8); opacity: 0; pointer-events: none; animation: keyFlash 0.15s ease-out; }
  @keyframes keyFlash { 0% { opacity: 0.8; } 100% { opacity: 0; } }
  .kb-key.kb-version { background: none; border: none; box-shadow: none; color: #444; font-size: 14px; font-weight: 900; pointer-events: none; opacity: 0.7; }
  .kb-key[data-key="1"] { grid-area: k1; } .kb-key[data-key="2"] { grid-area: k2; } .kb-key[data-key="3"] { grid-area: k3; } .kb-key[data-key="4"] { grid-area: k4; }
  .kb-key[data-key="5"] { grid-area: k5; } .kb-key[data-key="6"] { grid-area: k6; } .kb-key[data-key="7"] { grid-area: k7; } .kb-key[data-key="8"] { grid-area: k8; }
  .kb-key[data-key="9"] { grid-area: k9; } .kb-key[data-key="0"] { grid-area: k0; } .kb-key[data-key="DEL"] { grid-area: del; } .kb-key.kb-version { grid-area: ver; }

  #bottom-ui-container { position: absolute; bottom: 0; left: 0; width: 100%; height: var(--footer-total-height); display: none; align-items: flex-start; justify-content: center; padding: 0 15px; padding-top: 10px; z-index: 3100; pointer-events: auto; transition: opacity 0.2s, filter 0.2s; }
  #mode-select-container { display: flex; width: 100%; gap: 8px; justify-content: center; height: 55px; }
  .mode-btn { flex: 1; height: 100%; font-family: var(--font-ui); border: 3px solid #fff; border-radius: 6px; transform: skewX(-15deg); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 6px 6px 0 rgba(0,0,0,0.8); position: relative; padding: 4px 0; overflow: hidden; transition: transform 0.1s, box-shadow 0.1s; color: #fff; -webkit-text-stroke: 0; text-shadow: 1px 1px 1px #000; }
  .mode-btn:active { transform: skewX(-15deg) translateY(6px); box-shadow: 0 0 0 rgba(0,0,0,0); filter: brightness(1.2); }
  .mode-easy { background: linear-gradient(170deg, #55ff33 0%, #1a800d 100%); } .mode-normal { background: linear-gradient(170deg, #00aaff 0%, #004080 100%); } .mode-hard { background: linear-gradient(170deg, #ffcc00 0%, #997a00 100%); } .mode-extreme { background: linear-gradient(170deg, #ff0022 0%, #80000f 100%); }
  .mode-val { font-size: clamp(12px, 3.5vw, 18px); font-weight: 900; font-style: italic; text-transform: uppercase; white-space: nowrap; z-index: 1; letter-spacing: -1px; }
  .mode-btn.locked { opacity: 0.3; filter: grayscale(1); pointer-events: none; border-color: #333; color: #555; background: #111; }
  .mode-btn.locked .mode-val { display: none; }
  .mode-btn.locked::after { content: 'üîí'; font-size: 24px; display: block; z-index:1; color: #555; -webkit-text-stroke: 0; }
  .bottom-ui-dimmed { opacity: 0.25; filter: grayscale(0.6); pointer-events: none; }

  #tutorial-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 4000; pointer-events: none; opacity: 0; transition: opacity 0.3s; }
  #tutorial-overlay.active { opacity: 1; pointer-events: auto; }
  .tute-item { position: absolute; display: flex; flex-direction: column; align-items: center; color: #fff; filter: drop-shadow(0 0 8px rgba(0,0,0,0.8)); }
  #tute-central-msg { position: absolute; top: 38%; left: 50%; transform: translate(-50%, -50%); width: 100%; z-index: 5000; display:flex; justify-content:center; flex-direction: column; align-items: center; gap: 16px; }
  .tute-big-msg { font-size: clamp(30px, 10vw, 75px); font-weight: 900; font-style: italic; transition: transform 0.1s; letter-spacing: -6px; color: #fff; display:none; margin-bottom: 20px; z-index: 5001; paint-order: stroke fill; -webkit-text-stroke: 2px #000; text-shadow: 5px 5px 0 #000; }
  .tute-big-msg.pop { transform: scale(1.8) skewX(-10deg); }
  .tute-start-btn { padding: clamp(15px, 4vw, 20px) clamp(30px, 8vw, 50px); border-radius: 8px; border: 4px solid #fff; background: linear-gradient(170deg, #00aaff 0%, #004080 100%); color: #fff; text-shadow: 3px 3px 0 #000; paint-order: stroke fill; -webkit-text-stroke: 1.5px #000; font-size: clamp(24px, 8vw, 36px); font-weight: 900; font-style: italic; letter-spacing: -2px; text-transform: uppercase; cursor: pointer; box-shadow: 10px 10px 0 #000; transform: skewX(-12deg); transition: transform 0.1s, box-shadow 0.1s; position: relative; overflow: visible; z-index: 10; }
  .tute-start-btn:active { transform: skewX(-12deg) translateY(6px); box-shadow: 4px 4px 0 #000; background: linear-gradient(170deg, #0088cc 0%, #003366 100%); }
  .tute-start-btn::before { content: ''; position: absolute; inset: -10px; border-radius: inherit; border: 8px solid rgba(0, 170, 255, 0.8); opacity: 0; pointer-events: none; animation: modeSelectPulse 0.9s ease-out infinite; z-index: -1; }
  @keyframes modeSelectPulse { 0% { transform: scale(0.95); opacity: 1; border-width: 8px; } 40% { opacity: 0.9; } 100% { transform: scale(1.35); opacity: 0; border-width: 0px; } }
  .tute-mode-select { display: none; width: 95%; max-width: 460px; flex-direction: row; gap: 8px; justify-content: center; }
  .tute-mode-select .mode-btn { height: clamp(60px, 15vh, 80px); }

  #how-to-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); z-index: 7000; display: none; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; padding: 20px; padding-top: calc(20px + env(safe-area-inset-top)); padding-bottom: calc(20px + env(safe-area-inset-bottom)); }
  #how-to-modal.active { display: flex; opacity: 1; pointer-events: auto; }
  .ht-container { width: 100%; max-width: 500px; height: 100%; background: #111; border: 4px solid #fff; border-radius: 12px; transform: skewX(-2deg); box-shadow: 0 0 50px rgba(0, 170, 255, 0.2), 15px 15px 0 #000; position: relative; display: flex; flex-direction: column; overflow: hidden; }
  .ht-header { background: linear-gradient(90deg, #00aaff, #004488); padding: 15px 20px; border-bottom: 3px solid #fff; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; z-index:10; box-shadow: 0 5px 10px rgba(0,0,0,0.5); }
  .ht-title { font-size: 24px; font-weight: 900; font-style: italic; color: #fff; paint-order: stroke fill; -webkit-text-stroke: 1.5px #000; text-shadow: 3px 3px 0 rgba(0,0,0,0.5); letter-spacing: -1px; }
  .ht-close-btn { background: #000; border: 2px solid #fff; color: #fff; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; cursor: pointer; transition: transform 0.1s; box-shadow: 3px 3px 0 rgba(0,0,0,0.5); }
  .ht-close-btn:active { transform: scale(0.9); }
  .ht-body { padding: 20px 25px; padding-bottom: 80px; background: repeating-linear-gradient(45deg, rgba(255,255,255,0.03) 0, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 15px), radial-gradient(circle at center, #222 0%, #000 100%); display: flex; flex-direction: column; gap: 20px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
  .ht-intro-box { border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; padding: 12px; background: rgba(255,255,255,0.05); text-align: center; }
  .ht-intro-title { color: #aaa; font-size: 10px; font-weight: 900; letter-spacing: 2px; margin-bottom: 6px; }
  .ht-intro-text { font-size: 13px; line-height: 1.6; color: #eee; font-weight: 700; font-family: var(--font-num); }
  .highlight { color: #00ffff; font-weight: 900; text-decoration: underline; }
  .ht-sec-title { font-size: 18px; font-weight: 900; font-style: italic; color: #fff; border-bottom: 4px solid #fff; margin-top: 10px; margin-bottom: 5px; padding-bottom: 4px; text-shadow: 2px 2px 0 #000; letter-spacing: -1px; }
  .ht-flow-step { display: flex; align-items: center; background: rgba(0,0,0,0.4); border: 1px solid #444; border-radius: 8px; padding: 15px 10px 10px 10px; position: relative; overflow: visible; box-shadow: 4px 4px 0 rgba(0,0,0,0.5); margin-top: 10px; }
  .ht-step-badge { position: absolute; top: -10px; left: 10px; background: #fff; color: #000; font-size: 10px; font-weight: 900; padding: 2px 10px; border-radius: 4px; border: 2px solid #000; box-shadow: 2px 2px 0 rgba(0,0,0,0.5); z-index: 5; }
  .ht-step-text { flex: 1; padding-left: 10px; }
  .step-head { font-size: 18px; font-weight: 900; color: var(--g-perf); margin-bottom: 2px; text-shadow: 1px 1px 0 #000; }
  .step-desc { font-size: 11px; color: #ccc; line-height: 1.3; font-family: var(--font-num); }
  .ht-step-icon { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: 50%; }
  .ht-step-icon i { width: 28px; height: 28px; color: #fff; }
  .ht-flow-arrow { text-align: center; color: #555; font-size: 10px; transform: scaleY(0.6); }
  .ht-judge-box { display: flex; flex-direction: column; gap: 10px; }
  .ht-judge-desc { font-size: 12px; color: #ccc; text-align: center; margin-bottom: 5px; line-height: 1.4; }
  .ht-meter-demo { display: flex; align-items: center; gap: 8px; background: #000; padding: 10px; border-radius: 6px; border: 1px solid #333; }
  .meter-label { font-size: 10px; color: #888; font-weight: 900; width: 35px; text-align: center; }
  .meter-bar { flex: 1; height: 24px; display: flex; border-radius: 4px; overflow: hidden; }
  .m-seg { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 900; color: #000; box-shadow: inset 0 0 2px rgba(0,0,0,0.5); }
  .seg-marv { background: var(--g-exc); flex: 1; } .seg-exc { background: var(--g-perf); flex: 1; } .seg-grt { background: var(--g-grt); flex: 1.5; } .seg-good { background: var(--g-good); flex: 2; } .seg-ok { background: var(--g-ok); flex: 2; }
  .ht-rank-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 5px; }
  .rank-cell { background: rgba(30, 30, 30, 0.6); border: 2px solid currentColor; border-radius: 6px; padding: 8px 0; text-align: center; font-weight: 900; font-size: 18px; font-style: italic; display: flex; flex-direction: column; align-items: center; justify-content: center; text-shadow: 1px 1px 0 #000; box-shadow: inset 0 0 10px rgba(255,255,255,0.05), 0 0 8px currentColor; }
  .c-secret { color: #555; } .c-s { color: #ffdd00; } .c-a { color: #00ffff; } .c-b { color: #00ff2a; } .c-c { color: #ffaa00; } .c-d { color: #b0b0b0; }
  .ht-mode-list { display: flex; flex-direction: column; gap: 10px; }
  .ht-mode-item { border: 2px solid #444; border-radius: 6px; overflow: hidden; }
  .m-easy { border-color: var(--c-easy); } .m-hard { border-color: var(--c-hard); } .m-random { border-color: var(--c-random); }
  .hm-head { padding: 6px 10px; font-size: 12px; font-weight: 900; font-style: italic; color: #000; }
  .m-easy .hm-head { background: var(--c-easy); } .m-hard .hm-head { background: var(--c-hard); } .m-random .hm-head { background: var(--c-random); color: #fff; text-shadow: 1px 1px 0 #000; }
  .hm-body { padding: 10px; font-size: 11px; line-height: 1.4; color: #ddd; background: rgba(0,0,0,0.5); }
  .hl { color: #fff; font-weight: 900; text-decoration: underline; }
  .ht-unlock-list { display: flex; flex-direction: column; gap: 8px; }
  .ht-unlock-item { display: flex; align-items: center; border-bottom: 1px solid #333; padding-bottom: 8px; }
  .ul-target { width: 80px; font-size: 12px; font-weight: 900; color: #fff; font-style: italic; }
  .ul-cond { flex: 1; font-size: 11px; color: #ccc; line-height: 1.3; font-family: var(--font-num); }
  .ht-ch-box { background: linear-gradient(135deg, #111 0%, #222 100%); border: 1px solid #555; border-radius: 8px; padding: 15px; text-align: center; box-shadow: inset 0 0 20px rgba(0,0,0,0.8); }
  .ch-big { font-size: 20px; font-weight: 900; font-style: italic; color: #fff; margin-bottom: 8px; text-shadow: 2px 2px 0 #000; }
  .ch-desc { font-size: 11px; color: #aaa; line-height: 1.5; font-family: var(--font-num); }
  .ht-footer { margin-top: 10px; padding-top: 15px; border-top: 1px dashed #444; text-align: center; }

  .eval-effect { position: fixed; top: calc(20% - 30px - 3.0cm); left: 50%; transform: translateX(-50%) scale(0.35); font-family: var(--font-ui); font-size: min(50px, 12vw); font-weight: 900; font-style: italic; letter-spacing: -3px; z-index: 10000; pointer-events: none; paint-order: stroke fill; -webkit-text-stroke: 2.5px #000; text-shadow: 4px 4px 0px rgba(0,0,0,0.8); animation: SNOWHit 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; white-space: nowrap; }
  @keyframes SNOWHit { 0% { transform: translateX(-50%) scale(2) rotate(-15deg); opacity: 0; } 20% { opacity: 1; transform: translateX(-50%) scale(0.9) rotate(0deg); } 40% { transform: translateX(-50%) scale(1.0); } 90% { opacity: 1; transform: translateX(-50%) scale(1.0); } 100% { transform: translateX(-50%) scale(1.2) translateY(-20px); opacity: 0; } }

  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 6000; display: none; flex-direction: column; align-items: center; justify-content: center; }
  .modal-overlay.show { display: flex; animation: fadeIn 0.2s; }
  @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

  .result-card { width: 100%; height: 100%; background: #111; display: flex; flex-direction: column; position: relative; color: #fff; overflow: hidden; transition: background 0.5s; }
  .result-card::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; z-index: 0; pointer-events: none; opacity: 0.25; background: conic-gradient(from 0deg, transparent 0deg, rgba(255,255,255,0.2) 60deg, transparent 120deg, rgba(255,255,255,0.2) 180deg, transparent 240deg); animation: rotateBg 15s linear infinite; display: none; }
  @keyframes rotateBg { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .result-card.bg-god::before { display: block; opacity: 0.3; } .result-card.bg-z::before { display: block; background: conic-gradient(from 0deg, transparent 0deg, rgba(255,0,0,0.3) 45deg, transparent 90deg, rgba(255,0,0,0.3) 135deg, transparent 180deg); opacity: 0.5; animation-duration: 6s; } .result-card.bg-s::before { display: block; background: conic-gradient(from 0deg, transparent 0deg, rgba(255,255,0,0.1) 60deg, transparent 120deg); opacity: 0.2; }
  .result-card.bg-z { background: radial-gradient(circle at center, #220000 0%, #110000 60%, #000 100%); box-shadow: inset 0 0 100px #300; }
  .result-card.bg-god { background: linear-gradient(to bottom, #fffbe0 0%, #ffd700 40%, #b8860b 80%, #000 100%); }
  .result-card.bg-s { background: radial-gradient(circle at center, #665500 0%, #332a00 80%, #000 100%); }
  .result-card.bg-a { background: radial-gradient(circle at center, #004444 0%, #002222 80%, #000 100%); }
  .result-card.bg-b { background: radial-gradient(circle at center, #004411 0%, #002208 80%, #000 100%); }
  .result-card.bg-c { background: radial-gradient(circle at center, #442200 0%, #221100 80%, #000 100%); }
  .result-card.bg-d { background: radial-gradient(circle at center, #222222 0%, #111 80%, #000 100%); }

  .result-scroll-area { flex: 1; overflow-y: auto; display: flex; flex-direction: column; padding: 20px; padding-bottom: calc(var(--footer-total-height) + 20px); padding-top: env(safe-area-inset-top, 20px); position:relative; z-index:2; -webkit-overflow-scrolling: touch; }
  .res-header-row { display: flex; justify-content: space-between; align-items: center; padding-bottom: 8px; margin-bottom: 10px; flex-shrink: 0; position: relative; border-bottom: 4px solid #fff; }
  .res-title { font-size: 32px; font-weight: 900; font-style: italic; letter-spacing: -3px; paint-order: stroke fill; -webkit-text-stroke: 1.5px #000; text-shadow: 3px 3px 0 #000; }
  .res-status-msg { font-size: min(50px, 12vw); font-weight: 900; font-style: italic; margin-top: 10px; display: none; text-transform: uppercase; letter-spacing: -4px; paint-order: stroke fill; -webkit-text-stroke: 2px #000; transform: skewX(-10deg) scale(1, 1.1); filter: drop-shadow(5px 5px 0 #000); text-align: center; line-height: 0.9; padding-right: 0.2em; }
  .res-status-msg.show { display: block; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  @keyframes popIn { from { transform: translateY(20px) scale(0.5) skewX(-10deg); opacity: 0; } to { transform: translateY(0) scale(1) skewX(-10deg); opacity: 1; } }
  .status-clear { color: #fff; background: linear-gradient(to bottom, #fff 30%, #00aaff 60%, #003366 100%); -webkit-background-clip: text; color: transparent; -webkit-text-stroke: 0; text-shadow: 0 0 10px rgba(0,170,255,0.8); position: relative; }
  .res-unlock-wrapper { display: none; justify-content: center; margin-top: 20px; margin-bottom: 15px; }
  .res-unlock-wrapper.show { display: flex; }
  .unlock-badge { display: inline-flex; flex-direction: column; align-items: center; justify-content: center; width: 300px; padding: 15px 0; background: #000; color: #fff; border: 6px solid currentColor; font-family: var(--font-ui); font-weight: 900; font-style: italic; text-transform: uppercase; transform: rotate(-3deg) scale(1); box-shadow: 15px 15px 0 rgba(0,0,0,1), 0 0 30px currentColor; animation: smashStampIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; position: relative; overflow: hidden; z-index: 100; }
  @keyframes smashStampIn { 0% { transform: scale(3) rotate(15deg); opacity: 0; } 70% { transform: scale(0.9) rotate(-5deg); opacity: 1; } 100% { transform: scale(1) rotate(-3deg); opacity: 1; } }
  .unlock-badge::before { content: ''; position: absolute; top:0; left:0; width:100%; height:100%; background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.15) 10px, rgba(255,255,255,0.15) 20px); pointer-events: none; }
  .unlock-badge.mode-normal { color: #00aaff; background: #000c1a; border-color: #00aaff; } .unlock-badge.mode-hard { color: #ffcc00; background: #1a1400; border-color: #ffcc00; } .unlock-badge.mode-extreme { color: #ff0022; background: #1a0003; border-color: #ff0022; }
  .unlock-badge .main-text { font-size: 42px; line-height: 0.85; letter-spacing: -3px; text-shadow: 4px 4px 0 #000; z-index: 1; paint-order: stroke fill; -webkit-text-stroke: 2px #000; color: #fff; }
  .unlock-badge .sub-text { font-size: 20px; margin-top: 6px; letter-spacing: 2px; background: #fff; color: #000; padding: 2px 24px; font-weight: 900; z-index: 1; transform: skewX(-15deg); box-shadow: 4px 4px 0 rgba(0,0,0,0.8); border: 2px solid #000; }

  .res-mode-label { font-size: 12px; font-weight: 900; font-style: italic; padding: 4px 20px; background: #000; border-radius: 4px; letter-spacing: -0.5px; border: 3px solid #fff; transform: skewX(-15deg); box-shadow: 3px 3px 0 #000; }
  .rank-section { display: flex; flex-direction: column; align-items: center; margin-bottom: 10px; padding-bottom: 10px; position: relative; flex-shrink: 0; z-index: 5; }
  .rank-wrapper { display: flex; align-items: flex-end; justify-content: center; position: relative; width: 100%; text-align: center; }
  .rank-char { font-family: var(--font-ui); font-style: normal; font-size: clamp(80px, 20vh, 110px); line-height: 0.8; font-weight: 900; transform: skewX(-15deg); margin-right: 0; padding-right: 20px; paint-order: stroke fill; -webkit-text-stroke: 4px #000; filter: drop-shadow(8px 8px 0 rgba(0,0,0,0.8)); }
  .rank-char.rank-nicetry { font-size: clamp(36px, 10vw, 50px); -webkit-text-stroke: 2.5px #000; margin-right: 0; padding-right: 0; color: #fff; letter-spacing: -3px; }
  .rank-god { background: linear-gradient(135deg, #ffffff 0%, #fffacd 20%, #ffd700 40%, #daa520 60%, #ffffff 100%); background-size: 200% 200%; -webkit-background-clip: text; color: transparent; -webkit-text-stroke: 0; animation: godShine 3s ease-in-out infinite; filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.8)) drop-shadow(0 0 30px rgba(255, 255, 255, 0.6)); z-index: 10; }
  @keyframes godShine { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
  .rank-z { position: relative; z-index: 10; color: #000; -webkit-text-stroke: 6px #000; paint-order: stroke fill; filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.8)); }
  .rank-z::after { content: 'Z'; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: linear-gradient(180deg, #ffdddd 0%, #ff0000 30%, #cc0000 70%, #660000 100%); -webkit-background-clip: text; color: transparent; -webkit-text-stroke: 0; filter: drop-shadow(0 0 5px rgba(255, 50, 50, 0.8)); }
  .rank-s { color: #ffdd00; text-shadow: 4px 4px 0 #b38600; } .rank-a { color: #00ccff; text-shadow: 4px 4px 0 #005580; } .rank-b { color: #33ff55; text-shadow: 4px 4px 0 #0f4d1a; } .rank-c { color: #ff8800; text-shadow: 4px 4px 0 #804400; } .rank-f { color: #888; text-shadow: 4px 4px 0 #222; }
  .res-msg-platinum, .res-msg-nice { color: #ffffff !important; background: none !important; -webkit-background-clip: initial !important; filter: none !important; text-shadow: 3px 3px 0 #000 !important; font-weight: 900; -webkit-text-stroke: 1.5px #000 !important;}
  .nav-btn { pointer-events: auto; background: #333; color: #fff; width: 44px; height: 44px; border-radius: 50%; border: 3px solid #fff; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.1s; flex-shrink: 0; box-shadow: 4px 4px 0 #000; }
  .nav-btn:active { background: #fff; color:#000; transform: scale(0.9); box-shadow: 0 0 0 #000; }
  .nav-btn:disabled { opacity: 0; pointer-events: none; }
  .new-record-badge { background: linear-gradient(to bottom, #fff 30%, #ffd700 60%, #b8860b 100%); -webkit-background-clip: text; color: transparent; -webkit-text-stroke: 0; font-size: 42px; font-weight: 900; font-style: italic; line-height: 1.0; padding: 0 10px; margin-right: -10px; margin-bottom: 5px; filter: drop-shadow(5px 5px 0px #000) drop-shadow(0 0 20px rgba(255, 215, 0, 0.6)); display: none; align-items: center; justify-content: center; transform: skewX(-10deg) rotate(-3deg); position: relative; z-index: 9999; letter-spacing: -3px; pointer-events: none; }
  .new-record-badge.show { display: inline-block; animation: badgePopSmash 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  @keyframes badgePopSmash { 0% { transform: scale(3) skewX(-10deg) rotate(10deg); opacity: 0; } 100% { transform: scale(1) skewX(-10deg) rotate(-3deg); opacity: 1; } }

  .score-row-container { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; margin-top: 5px; margin-bottom: 5px; position: relative; z-index: 5000; }
  .total-score-box { font-family: var(--font-ui); text-align: center; font-size: 38px; font-weight: 900; font-style: italic; color: #fff; text-shadow: 4px 4px 0 #000; letter-spacing: -2px; line-height: 1.0; paint-order: stroke fill; -webkit-text-stroke: 1.5px #000; }
  .total-score-box span.total-label { font-size: 14px; color: #ddd; display: block; margin-bottom: 2px; letter-spacing: 1px; text-transform: uppercase; text-shadow: 2px 2px 0 #000; font-weight: 900; -webkit-text-stroke: 0; font-style: normal; }
  .total-avg-label { display: block; margin-top: 4px; font-weight: 900; font-style: italic; text-shadow: 2px 2px 0 #000; -webkit-text-stroke: 0; }
  .total-avg-label .avg-text { font-size: 0.6em; color: #aaa; letter-spacing: 1px; margin-right: 4px; }
  .total-avg-label .avg-value { font-size: 1em; color: #fff; }
  .next-rank-line { margin-top: 8px; font-size: 18px; font-weight: 900; letter-spacing: -1px; opacity: 0.9; text-shadow: 2px 2px 0 #000; -webkit-text-stroke: 0.5px #000; font-style: italic; }

  .detail-table { width: 100%; margin-bottom: 5px; border-collapse: collapse; font-family: var(--font-num); font-size: 14px; }
  .detail-table th { text-align: left; color: #bbb; border-bottom: 2px solid #555; padding: 4px 4px; font-family: var(--font-ui); font-style: italic; font-weight: 900; font-size: 12px; letter-spacing: -0.5px; }
  .detail-table td { border-bottom: 1px solid #333; padding: 4px 4px; font-weight: 700; }
  .detail-table tr:last-child td { border-bottom: none; }
  .dt-grade { font-weight: 900; font-family: var(--font-ui); font-style: italic; width: 35%; text-shadow: 2px 2px 0 #000; -webkit-text-stroke: 0; letter-spacing: -1px; }
  .dt-count { text-align: right; width: 15%; color: #fff; }
  .dt-avg { text-align: right; width: 20%; color: #999; font-size: 12px; }
  .dt-score { text-align: right; font-weight: 900; color: #fff; width: 30%; letter-spacing: -1px; }
  .dt-sub { font-size: 10px; color: #777; margin-left: 2px; }

  .miss-log-container { background: transparent; padding: 0; margin-bottom: 0px; display: flex; flex-direction: column; flex: 1; overflow: hidden; min-height: 0; margin-top: 10px; }
  .miss-title { font-size: 16px; font-weight: 900; color: #fff; margin-bottom: 4px; font-style: italic; text-transform: uppercase; letter-spacing: -1px; flex-shrink: 0; text-shadow: 2px 2px 0 #000; -webkit-text-stroke: 0; }
  .miss-scroll-wrapper { flex: 1; overflow-y: visible; display: flex; flex-direction: column; gap: 4px; }
  .feedback-row { display: flex; flex-direction: column; background: rgba(50,50,50,0.3); border-radius: 4px; overflow: hidden; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.1); position: relative; }
  .fb-body { position: relative; height: 140px; display: flex; align-items: center; justify-content: center; overflow: hidden; transform-style: preserve-3d; perspective: 600px; }
  .fb-body-inner { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
  .fb-body-inner.fb-2d { transform: scale(0.7); display:flex; justify-content:center; align-items:flex-end; }
  .fb-body-inner.fb-3d { transform: scale(0.7); margin-top: 2cm; }
  .fb-body-inner.fb-extreme { transform: scale(0.45); }
  .fb-footer { position: absolute; top: 4px; right: 6px; display: flex; justify-content: flex-end; align-items: center; padding: 2px 8px; background: #000; font-size: 11px; font-weight: 900; font-family: var(--font-num); color: #ccc; text-shadow: none; z-index: 10; border-radius: 4px; border: 1px solid #555; }
  .fb-val-correct { color: var(--c-easy); margin-left: 4px; font-size: 12px; font-weight: 900;}
  .fb-val-wrong { color: var(--g-miss); margin-left: 4px; font-size: 12px; font-weight: 900;}
  .fb-lbl { margin-left: 8px; color: #888; font-size: 9px; letter-spacing: 0px;}

  .result-footer { position: absolute; bottom: 0; left: 0; width: 100%; height: var(--footer-total-height); padding: 0 30px; padding-bottom: var(--safe-area-bottom); background: linear-gradient(to top, #000 85%, transparent); display: flex; align-items: center; justify-content: space-between; gap: 10px; z-index: 10; }
  .unified-btn { flex: 0 0 auto; min-width: 220px; height: 60px; background: linear-gradient(170deg, #00aaff 0%, #004080 100%); color: #fff; font-family: var(--font-ui); font-size: 26px; font-weight: 900; font-style: italic; letter-spacing: -1.5px; border: 4px solid #fff; border-radius: 8px; cursor: pointer; transform: skewX(-12deg); box-shadow: 8px 8px 0 #000; transition: all 0.1s; display: flex; align-items: center; justify-content: center; margin: 0; position: relative; z-index: 10000; text-shadow: 2px 2px 0 #000; paint-order: stroke fill; -webkit-text-stroke: 1.5px #000; }
  .unified-btn:active { transform: skewX(-12deg) translateY(4px); box-shadow: 2px 2px 0 #000; background: linear-gradient(170deg, #0088cc 0%, #003366 100%); }
  .unified-btn::before { content: ''; position: absolute; inset: -8px; border-radius: inherit; border: 6px solid rgba(0, 170, 255, 0.8); opacity: 0; pointer-events: none; animation: modeSelectPulse 1.2s ease-out infinite; z-index: -1; }

  .z-particle { position: absolute; width: 4px; height: 4px; background: #ffcc00; border-radius: 50%; pointer-events: none; opacity: 0; box-shadow: 0 0 4px #ff0000; mix-blend-mode: screen; z-index: 5; bottom: -20px; animation: emberFloat linear infinite; }
  @keyframes emberFloat { 0% { transform: translateY(0) scale(0.5); opacity: 0; } 10% { opacity: 1; } 80% { opacity: 0.8; } 100% { transform: translateY(-120vh) scale(1.2); opacity: 0; } }
  .god-particle { position: absolute; background: linear-gradient(to top, transparent, rgba(255, 255, 200, 0.8), #fff, transparent); width: 2px; bottom: -100px; opacity: 0; z-index: 5; pointer-events: none; mix-blend-mode: screen; animation: godRise linear infinite; }
  @keyframes godRise { 0% { transform: translateY(0) scaleY(0.5); opacity: 0; } 20% { opacity: 0.8; transform: translateY(-30vh) scaleY(1); } 100% { transform: translateY(-130vh) scaleY(1.5); opacity: 0; } }
</style>
</head>
<body>

  <div class="app-container" id="app-wrapper">
    <div class="version-label"></div>
    <div class="stage-area">
      <div id="fail-shutter"></div>
      <div id="victory-shutter"></div>
      <div id="slow-overlay-fx"></div>
      <div id="hud-mode-label" class="mode-label">EASY</div>
      <div id="pool-container" style="display:none;"></div> 

      <div id="tutorial-overlay">
          <div id="login-streak-display"></div>
          <button id="btn-mode-toggle" onclick="toggleDimensionMode()">
              <span class="check">‚òê</span><span class="label">RANDOM</span>
          </button>
          
          <button id="btn-how-to-opening" class="btn-how-to-common" onclick="openHowTo()">
              <i data-lucide="help-circle" size="14"></i> HOW TO PLAY
          </button>
          <div id="tute-count" class="tute-item"></div>
          <div id="tute-input" class="tute-item"></div>
          <div id="tute-central-msg" class="tute-item">
              <button id="tute-start-btn" class="tute-start-btn">MODE SELECT</button>
              <div id="tute-mode-select" class="tute-mode-select">
                  <button class="mode-btn mode-easy" onclick="handleModeSelect('EASY', this)"><div class="mode-val">EASY</div></button>
                  <button class="mode-btn mode-normal" onclick="handleModeSelect('NORMAL', this)"><div class="mode-val">NORMAL</div></button>
                  <button class="mode-btn mode-hard" onclick="handleModeSelect('HARD', this)"><div class="mode-val">HARD</div></button>
                  <button class="mode-btn mode-extreme" onclick="handleModeSelect('EXTREME', this)"><div class="mode-val">EXTREME</div></button>
              </div>
              <div id="tute-big-msg" class="tute-big-msg">READY</div>
          </div>
      </div>

      <div id="conveyor-wrapper">
        <div id="slot-1" class="slot">
          <div id="flash-overlay-1" class="slot-flash-overlay"></div>
          <div id="view-1" style="flex:1; display:flex; justify-content:center; align-items:flex-end; width:100%; height:100%;"></div>
        </div>
        <div id="slot-2" class="slot">
          <div id="view-2" style="flex:1; display:flex; justify-content:center; align-items:flex-end;"></div>
        </div>
        <div id="slot-3" class="slot">
          <div id="view-3" style="flex:1; display:flex; justify-content:center; align-items:flex-end;"></div>
        </div>
      </div>
    </div>

    <div id="kb-toolbar">
        <button id="btn-key-layout-toggle" class="btn-color-a">KEYBOARD TYPE A</button>
        <button id="btn-slow-mo" onclick="activateSlowMo()">
            <div id="ts-charges" class="ts-charge-container"></div>
        </button>
    </div>

    <div class="virtual-keyboard layout-phone" id="virtual-keyboard">
        <button class="kb-key" data-key="1"><div class="kb-key-main">1</div></button>
        <button class="kb-key" data-key="2"><div class="kb-key-main">2</div></button>
        <button class="kb-key" data-key="3"><div class="kb-key-main">3</div></button>
        <button class="kb-key" data-key="4"><div class="kb-key-main">4</div></button>
        <button class="kb-key" data-key="5"><div class="kb-key-main">5</div></button>
        <button class="kb-key" data-key="6"><div class="kb-key-main">6</div></button>
        <button class="kb-key" data-key="7"><div class="kb-key-main">7</div></button>
        <button class="kb-key" data-key="8"><div class="kb-key-main">8</div></button>
        <button class="kb-key" data-key="9"><div class="kb-key-main">9</div></button>
        <div class="kb-key kb-version"></div>
        <button class="kb-key" data-key="0"><div class="kb-key-main">0</div></button>
        <button class="kb-key" data-key="DEL"><div class="kb-key-main" style="font-size:18px;">DEL</div></button>
    </div>

    <div id="bottom-ui-container">
        <button id="btn-how-to-bottom" class="btn-how-to-common" onclick="openHowTo()">
            <i data-lucide="help-circle" size="14"></i> HELP
        </button>
        <div id="mode-select-container">
            <button class="mode-btn mode-easy active-mode" onclick="handleModeSelect('EASY', this)"><div class="mode-val">EASY</div></button>
            <button class="mode-btn mode-normal" onclick="handleModeSelect('NORMAL', this)"><div class="mode-val">NORMAL</div></button>
            <button class="mode-btn mode-hard" onclick="handleModeSelect('HARD', this)"><div class="mode-val">HARD</div></button>
            <button class="mode-btn mode-extreme" onclick="handleModeSelect('EXTREME', this)"><div class="mode-val">EXTREME</div></button>
        </div>
    </div>

  <div id="how-to-modal">
      <div class="ht-container">
          <div class="ht-header"><div class="ht-title">HOW TO PLAY</div><div class="ht-close-btn" onclick="closeHowTo()">‚úï</div></div>
          <div class="ht-body">
              <div class="ht-intro-box"><div class="ht-intro-title">BRAIN TRAINING</div><p class="ht-intro-text">"Subitizing"Ôºà„Çµ„Éì„Çø„Ç§„Ç∏„É≥„Ç∞Ôºâ„Å®„ÅØ„ÄÅÊï∞„ÇíÔºë„Å§„Åö„Å§Êï∞„Åà„Å™„Åè„Å¶„ÇÇ<br><span class="highlight">Áû¨ÊôÇ„Å´„Äå„ÅÑ„Åè„Å§„ÅÇ„Çã„Åã„Äç„ÇíÊääÊè°„Åß„Åç„ÇãËÉΩÂäõ</span>„ÅÆ„Åì„Å®„ÄÇ<br>Áúº„Å®ËÑ≥„ÅÆÂèçÂ∞ÑÁ•ûÁµå„ÇíÊ•µÈôê„Åæ„ÅßÈ´ò„ÇÅ„ÇçÔºÅ</p></div>
              <div class="ht-intro-box" style="margin-top:-10px; border-color: #00aaff; background: rgba(0,170,255,0.1);"><div class="ht-intro-title" style="color:#00ffff;">GAME RULE</div><p class="ht-intro-text" style="font-size:14px; color:#fff;">ÂÖ®10Âïè (Total 10 Questions)<br>ÊúÄÈÄü„Åß„ÇØ„É™„Ç¢„ÇíÁõÆÊåá„ÅõÔºÅ</p></div>
              <div class="ht-sec-title">GAME FLOW</div>
              <div class="ht-flow-step"><div class="ht-step-badge">STEP 1</div><div class="ht-step-text"><div class="step-head">‰∏ÄÁï™Â∑¶„ÇíË¶ã„ÇçÔºÅ</div><div class="step-desc">Â∑¶Á´Ø„ÅÆ„É¨„Éº„É≥„Åå„Çø„Éº„Ç≤„ÉÉ„Éà„Å†„ÄÇ<br>Ê¨°„ÄÖ„Å®Ëø´„Çã„Éñ„É≠„ÉÉ„ÇØ„ÇíÁû¨ÊôÇ„Å´Êçâ„Åà„Çç„ÄÇ</div></div><div class="ht-step-icon"><i data-lucide="eye"></i></div></div>
              <div class="ht-flow-arrow">‚ñº</div>
              <div class="ht-flow-step"><div class="ht-step-badge">STEP 2</div><div class="ht-step-text"><div class="step-head">Áõ¥ÊÑü</div><div class="step-desc">„Äå1, 2, 3...„Äç„Å®Êï∞„Åà„Å¶„ÅØ„ÅÑ„Åë„Å™„ÅÑ„ÄÇ<br>„ÄåÂΩ¢„Äç„Å®„Åó„Å¶Êï∞„ÇíË™çË≠ò„Åô„Çã„Çì„Å†„ÄÇ</div></div><div class="ht-step-icon"><i data-lucide="brain-circuit"></i></div></div>
              <div class="ht-flow-arrow">‚ñº</div>
              <div class="ht-flow-step"><div class="ht-step-badge">STEP 3</div><div class="ht-step-text"><div class="step-head">ÂÖ•Âäõ</div><div class="step-desc">Êï∞Â≠ó„Ç≠„Éº„ÇíÂè©„ÅëÔºÅ<br>ÂõûÁ≠î„Çπ„Éî„Éº„Éâ„ÅåÈÄü„ÅÑ„Åª„Å©„Çπ„Ç≥„Ç¢„Ç¢„ÉÉ„Éó„ÄÇ</div></div><div class="ht-step-icon"><i data-lucide="zap" style="color:#fff700"></i></div></div>
              <div class="ht-sec-title">MODES</div>
              <div class="ht-mode-list"><div class="ht-mode-item m-easy"><div class="hm-head">EASY / NORMAL</div><div class="hm-body">Âü∫Êú¨„É¢„Éº„Éâ„ÄÇ<br>ÂÖ•Âäõ„ÅØÂ∏∏„Å´<span class="hl">1Ê°Å</span>„ÄÇ</div></div><div class="ht-mode-item m-hard"><div class="hm-head">HARD / EXTREME</div><div class="hm-body">‰∏äÁ¥öËÄÖÂêë„Åë„ÄÇ<br>ÂÖ•Âäõ„ÅØÂ∏∏„Å´<span class="hl">2Ê°Å</span>„ÄÇ</div></div><div class="ht-mode-item m-random"><div class="hm-head">RANDOM (Ë∂Ö‰∏äÁ¥öËÄÖÂêë„Åë)</div><div class="hm-body">ÈÖçÁΩÆ„ÅåÂÆåÂÖ®„Å´„Éê„É©„Éê„É©„Å´„Å™„Çã„Ç´„Ç™„Çπ„É¢„Éº„Éâ„ÄÇ<br>Á©∫ÈñìË™çË≠òËÉΩÂäõ„ÅÆÈôêÁïå„Å´Êåë„ÇÅ„ÄÇ<br>‚ÄªÂè≥‰∏ä„ÅÆ„Éú„Çø„É≥„ÅßON/OFFÂàáÊõø</div></div></div>
              <div class="ht-sec-title">UNLOCK CONDITIONS</div>
              <div class="ht-unlock-list"><div class="ht-unlock-item"><span class="ul-target">NORMAL</span><span class="ul-cond">EASY„Åß <span class="c-a" style="font-weight:900;">„É©„É≥„ÇØA</span> ‰ª•‰∏ä</span></div><div class="ht-unlock-item"><span class="ul-target">HARD</span><span class="ul-cond">EASY„Åß <span class="c-s" style="font-weight:900;">„É©„É≥„ÇØS</span> ‰ª•‰∏ä<br>„Åæ„Åü„ÅØ NORMAL„Åß <span class="c-a" style="font-weight:900;">„É©„É≥„ÇØA</span> ‰ª•‰∏ä</span></div><div class="ht-unlock-item"><span class="ul-target">EXTREME</span><span class="ul-cond">NORMAL„Åß <span class="c-s" style="font-weight:900;">„É©„É≥„ÇØS</span> ‰ª•‰∏ä<br>„Åæ„Åü„ÅØ HARD„Åß <span class="c-a" style="font-weight:900;">„É©„É≥„ÇØA</span> ‰ª•‰∏ä</span></div></div>
              <div class="ht-sec-title">WHAT IS "ch"?</div>
              <div class="ht-ch-box"><div class="ch-big">ch = Count per Hour</div><div class="ch-desc">„Äå1ÊôÇÈñì„ÅÇ„Åü„Çä‰Ωï„Ç¢„Ç§„ÉÜ„É†Âá¶ÁêÜ„Åß„Åç„Çã„Åã„Äç„Å®„ÅÑ„ÅÜÁîüÁî£ÊÄß„ÅÆÊåáÊ®ô„ÄÇ<br>Ê≠£Á¢∫„Åã„Å§È´òÈÄü„Å´Âá¶ÁêÜ„Åô„Çã„Åì„Å®„Åß„ÄÅ„Åì„ÅÆÊï∞ÂÄ§„ÅØË∑≥„Å≠‰∏ä„Åå„Çã„ÄÇ<br></div></div>
          </div>
      </div>
  </div>

  <div id="result-modal" class="modal-overlay">
    <div id="result-card-container" class="result-card">
      <div class="result-scroll-area">
        <div class="res-header-row"><div class="res-title">RESULT</div><div id="res-mode-label" class="res-mode-label">NORMAL</div></div>
        <div class="rank-section">
            <div class="rank-wrapper"><div id="res-rank-char" class="rank-char">S</div><div id="res-rank-label-text" class="rank-label-text" style="font-size:14px;color:#888;font-weight:900;font-style:italic;">RANK</div></div>
            <div id="res-status-msg" class="res-status-msg">STAGE CLEAR</div>
            <div id="res-unlock-wrapper" class="res-unlock-wrapper"></div>
            <div id="res-msg" style="font-size:32px;font-weight:900;margin-top:5px;font-style:italic;color:var(--g-miss);text-shadow:3px 3px 0 #000;-webkit-text-stroke:0;"></div>
        </div>
        <div id="result-details">
            <table class="detail-table"><thead><tr><th>JUDGE</th><th style="text-align:right">COUNT</th><th style="text-align:right">AVG(s)</th><th style="text-align:right">SCORE</th></tr></thead><tbody id="detail-table-body"></tbody></table>
            <div class="score-row-container"><div id="new-record-badge" class="badge-common new-record-badge">NEW RECORD!!</div><div id="res-total-box" class="total-score-box"></div></div>
            <div id="miss-log" class="miss-log-container"><div class="miss-title">FEEDBACK</div><div id="miss-items-row" class="miss-scroll-wrapper"></div></div>
        </div>
      </div>
      <div class="result-footer">
          <button id="hist-prev" class="nav-btn"><i data-lucide="chevron-left"></i></button>
          <button class="unified-btn" onclick="resetToIdle()">ONE MORE GAME</button>
          <button id="hist-next" class="nav-btn"><i data-lucide="chevron-right"></i></button>
      </div>
    </div>
  </div>
  </div>
<script>
    if(window.lucide) lucide.createIcons();

    /* --- Ë®≠ÂÆö„ÉªÂÆöÊï∞ (CONFIG) --- */
    const CONFIG = {
        VERSION: 'Ver 43.6 FERMATA', 
        capPerItemSec: 0.1,
        capCh: 36000
    };

    const KB_SETTINGS = [
        { id: 'PHONE',   label: 'KEYBOARD TYPE A', btnClass: 'btn-color-a', layoutClass: 'layout-phone' },
        { id: 'CALC',    label: 'KEYBOARD TYPE B', btnClass: 'btn-color-b', layoutClass: 'layout-calc' },
        { id: 'SPECIAL', label: 'KEYBOARD TYPE C', btnClass: 'btn-color-c', layoutClass: 'layout-special' }
    ];

    const RANK_ORDER = ['GOD', 'Z', 'S', 'A', 'B', 'C', 'D', 'F'];
    const MODES = {
        'EASY': { 
            count: 10, time: 3.0, color: 'var(--c-easy)', type: 'STD',
            judgments: { marv: 0.5, exc: 1.0, great: 1.5, good: 2.0, ok: 3.0 },
            rankThresholds: { god: 12000, z: 10520, s: 7200, a: 5600, b: 3600, c: 1800, f: 0 }
        },
        'NORMAL': { 
            count: 10, time: 3.5, color: 'var(--c-normal)', type: 'STD',
            judgments: { marv: 0.65, exc: 0.9, great: 1.4, good: 2.0 },
            rankThresholds: { god: 10000, z: 9000, s: 6000, a: 4000, b: 2500, c: 1200, f: 0 }
        },
        'HARD': { 
            count: 10, time: 4.0, color: 'var(--c-hard)', type: 'HARD',
            judgments: { marv: 1.2, exc: 1.6, great: 2.5, good: 4.0 },
            rankThresholds: { god: 5000, z: 4000, s: 3000, a: 2000, b: 1200, c: 800, f: 0 }
        },
        'EXTREME': { 
            count: 10, time: 5.0, color: 'var(--c-extreme)', type: 'EXT',
            judgments: { marv: 2.0, exc: 3.0, great: 5.0 },
            rankThresholds: { god: 3800, z: 2800, s: 1800, a: 700, b: 500, c: 300, f: 0 }
        }
    };

    /* --- DOMÂèñÂæó„Éò„É´„Éë„Éº (ÂúßÁ∏ÆÁî®) --- */
    const $id = (id) => document.getElementById(id);
    const $qs = (s) => document.querySelector(s);
    const $qsa = (s) => document.querySelectorAll(s);

    /* --- „Éê„ÉÉ„Ç∞„Éª„Ç∑„Çπ„ÉÜ„É† (ÂÖ¨Âπ≥„Å™‰π±Êï∞) --- */
    const BagSystem = {
        bags: { EASY: [], NORMAL: [], HARD: [] },
        getNext: function(mode) {
            if (!this.bags[mode]) this.bags[mode] = [];
            if (this.bags[mode].length === 0) this.refill(mode);
            return this.bags[mode].pop();
        },
        refill: function(mode) {
            let arr = [];
            if (mode === 'EASY') { arr = [2,2, 3,3, 4,4,4, 5,5,5]; }
            else if (mode === 'NORMAL') { arr = [2,3,4, 5,5, 6,6, 7, 8, 9]; }
            else if (mode === 'HARD') { arr = [10,11,12,13,14,15,16,17,18,19,20]; }
            for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; }
            this.bags[mode] = arr;
        }
    };

    /* --- „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Éª„Éó„Éº„É´ --- */
    const DomPool = {
        poolContainer: null, 
        elements: { block: [], column: [], cube: [], cluster: [] },
        init: function() { this.poolContainer = $id('pool-container'); },
        get: function(type) {
            if (this.elements[type] && this.elements[type].length > 0) return this.elements[type].pop();
            if (type === 'block') { const d = document.createElement('div'); d.className = 'block'; return d; }
            else if (type === 'column') { const d = document.createElement('div'); d.className = 'block-column'; return d; }
            else if (type === 'cluster') { const d = document.createElement('div'); d.className = 'cluster-container'; return d; }
            else if (type === 'cube') { return this.createCubeDOM(); }
        },
        recycle: function(el, type) {
            if(!el || !this.poolContainer) return;
            el.className = ''; el.style.cssText = ''; 
            if (el.parentNode) el.parentNode.removeChild(el);
            if (type === 'cube') el.className = 'cube'; else if (type === 'block') el.className = 'block';
            this.poolContainer.appendChild(el); if(this.elements[type]) this.elements[type].push(el);
        },
        createCubeDOM: function() {
            const c=document.createElement('div'); c.className='cube';
            ['front','back','left','right','top','bottom'].forEach(f=>{ const d=document.createElement('div'); d.className='face face-'+f; c.appendChild(d); }); 
            return c;
        },
        clearView: function(viewEl) {
            while(viewEl.firstChild) {
                const cluster = viewEl.firstChild;
                while(cluster.firstChild) {
                    const child = cluster.firstChild;
                    if (child.classList.contains('block-column')) {
                         while(child.firstChild) this.recycle(child.firstChild, 'block');
                         this.recycle(child, 'column');
                    } else if (child.classList.contains('block')) this.recycle(child, 'block');
                    else if (child.classList.contains('cube')) this.recycle(child, 'cube');
                    else child.remove();
                }
                this.recycle(cluster, 'cluster');
            }
        }
    };

    /* --- „Çπ„ÉÜ„Éº„ÉàÁÆ°ÁêÜ --- */
    const STATE = {
        status: 'IDLE', is3DMode: false, isRandomMode: false, randomAtPlay: false,
        score: 0, queue: [], current: null, currentModeKey: 'EASY', rafId: null,
        // „Çπ„É≠„Éº„É¢„Éº„Ç∑„Éß„É≥Áî®
        elapsedTime: 0, 
        lastTick: 0, 
        slowUntil: 0, 
        chargesToday: 3, 
        
        totalPlayTime: 0, currentInput: '',
        statsDetail: { marvelous: { count:0, time:0 }, excellent: { count:0, time:0 }, great: { count:0, time:0 }, good: { count:0, time:0 }, ok: { count:0, time:0 } },
        missedLog: [], questionCount: 0, generatedCount: 0, isExtreme: false, isInputBlocked: false,
        currentKbLayout: 'PHONE', 
        saveData: {
            ranks2D: { EASY: null, NORMAL: null, HARD: null, EXTREME: null },
            ranks3D: { EASY: null, NORMAL: null, HARD: null, EXTREME: null },
            bestCH: 0, bestEasyCH: 0, modeScores: { EASY: 0, NORMAL: 0, HARD: 0, EXTREME: 0 }
        },
        history: [], historyIndex: 0, hasPlayedOnce: false, lastCount: null, lastShapeSig: null, consecutiveCountValue: 0
    };
let UI = {};
    const KB = { keys: {} };
    
    // Ë£è„Ç≥„Éû„É≥„ÉâÁî®Â§âÊï∞ (Admin Cheat)
    let lastSlashPressTime = 0;

    /* --- Ëµ∑ÂãïÊôÇÂá¶ÁêÜ (onload) --- */
    window.onload = () => {
        document.title = `SNOW: SMASH SUBITIZING - ${CONFIG.VERSION}`;
        if($qs('.version-label')) $qs('.version-label').innerText = CONFIG.VERSION;
        if($qs('.kb-key.kb-version')) $qs('.kb-key.kb-version').innerText = CONFIG.VERSION;

        UI = {
            appWrapper: $id('app-wrapper'), view1: $id('view-1'), view2: $id('view-2'), view3: $id('view-3'),
            slot1: $id('slot-1'), slot2: $id('slot-2'), slot3: $id('slot-3'),
            failShutter: $id('fail-shutter'), victoryShutter: $id('victory-shutter'),
            tutorialOverlay: $id('tutorial-overlay'), tuteBigMsg: $id('tute-big-msg'), tuteCentralMsg: $id('tute-central-msg'), 
            hudModeLabel: $id('hud-mode-label'), btnModeToggle: $id('btn-mode-toggle'),
            resultModal: $id('result-modal'), howToModal: $id('how-to-modal'), resultCardContainer: $id('result-card-container'), 
            resRankChar: $id('res-rank-char'), resRankLabelText: $id('res-rank-label-text'), resMsg: $id('res-msg'),
            resStatusMsg: $id('res-status-msg'), resUnlockWrapper: $id('res-unlock-wrapper'), resModeLabel: $id('res-mode-label'),
            resTotalBox: $id('res-total-box'), newRecordBadge: $id('new-record-badge'), missLog: $id('miss-log'),
            missItemsRow: $id('miss-items-row'), detailTableBody: $id('detail-table-body'),
            histPrev: $id('hist-prev'), histNext: $id('hist-next'), bottomUi: $id('bottom-ui-container'),
            tuteCount: $id('tute-count'), tuteInput: $id('tute-input'), tuteStartBtn: $id('tute-start-btn'),
            tuteModeSelect: $id('tute-mode-select'), virtualKeyboard: $id('virtual-keyboard'),
            btnHowToBottom: $id('btn-how-to-bottom'), btnHowToOpening: $id('btn-how-to-opening'),
            btnKeyLayoutToggle: $id('btn-key-layout-toggle'), btnSlowMo: $id('btn-slow-mo'),
            timerPathL: null, timerPathR: null
        };

        ['1','2','3','4','5','6','7','8','9','0','DEL'].forEach(k => { KB.keys[k] = $qs(`.kb-key[data-key="${k}"]`); });

        DomPool.init(); 
        initSlowMo();
        updateLoginStreak();
        initKeyLayout();
        adjustCentralLayout();
        resetToIdle();

        if(UI.histPrev) UI.histPrev.addEventListener('click', () => changeHistory(-1));
        if(UI.histNext) UI.histNext.addEventListener('click', () => changeHistory(1));
        if(UI.btnKeyLayoutToggle) UI.btnKeyLayoutToggle.addEventListener('click', toggleKeyLayout);
        if(UI.tuteStartBtn) UI.tuteStartBtn.addEventListener('click', handleTapToStart);

        if(UI.virtualKeyboard) {
            const handleKbInput = (e) => {
                const k = e.target.closest('.kb-key');
                if(!k || !k.dataset.key || k.classList.contains('disabled')) return;
                e.preventDefault();
                k.classList.add('active-state');
                triggerRipple(k);
                if(STATE.status === 'PLAYING') {
                    const valStr = k.dataset.key;
                    const mode = MODES[STATE.currentModeKey];
                    if (mode.type === 'EXT' || mode.type === 'HARD') processInputExtreme(valStr);
                    else { let val = parseInt(valStr, 10); if (!Number.isNaN(val)) processInput(val); }
                }
            };
            const clearState = (e) => { const k = e.target.closest('.kb-key'); if(k) k.classList.remove('active-state'); };
            UI.virtualKeyboard.addEventListener('touchstart', handleKbInput, {passive: false});
            UI.virtualKeyboard.addEventListener('mousedown', handleKbInput);
            UI.virtualKeyboard.addEventListener('touchend', clearState);
            UI.virtualKeyboard.addEventListener('mouseup', clearState);
            UI.virtualKeyboard.addEventListener('mouseleave', clearState);
        }

        window.addEventListener('keydown', (e) => {
            if(e.repeat) return;
            
            // ‚òÖË£è„Ç≥„Éû„É≥„Éâ: '/' (Slash) „ÅÆ„ÉÄ„Éñ„É´„Çø„ÉÉ„ÉóÊ§úÁü•
            if (e.key === '/') {
                const now = Date.now();
                if (now - lastSlashPressTime < 400) { // 0.4Áßí‰ª•ÂÜÖ„ÅÆÈÄ£Êâì„ÅßÁô∫Âãï
                    STATE.chargesToday = 3;
                    localStorage.setItem('snow_sm_left', 3);
                    renderSlowMoBtn();
                    // AdminÊ©üËÉΩ„ÅÆ„Åü„ÇÅ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Å™„Åó
                }
                lastSlashPressTime = now;
                return; 
            }

            if ((e.key === '.' || e.code === 'NumpadDecimal') && STATE.status === 'IDLE') { e.preventDefault(); toggleDimensionMode(); return; }
            if (STATE.isInputBlocked) { if(STATE.status === 'GAMEOVER' && e.key === 'Enter') resetToIdle(); return; }
            if(STATE.status === 'PLAYING') {
                const mode = MODES[STATE.currentModeKey];
                if (mode.type === 'EXT' || mode.type === 'HARD') {
                    if (e.key >= '0' && e.key <= '9') { animateKey(e.key); processInputExtreme(e.key); }
                    else if (e.key === 'Backspace' || e.key === 'Delete') { animateKey('DEL'); processInputExtreme('DEL'); }
                } else {
                    if(e.key >= '1' && e.key <= '9') { animateKey(e.key); processInput(parseInt(e.key, 10)); }
                }
            } else if(STATE.status === 'IDLE') {
                if(e.key === 'Enter') handleModeSelect(STATE.currentModeKey);
                if(e.key === '1') handleModeSelect('EASY');
                if(e.key === '2') handleModeSelect('NORMAL');
                if(e.key === '3') handleModeSelect('HARD');
                if(e.key === '4') handleModeSelect('EXTREME');
            } else if(STATE.status === 'GAMEOVER') { if(e.key === 'Enter') resetToIdle(); }
        });
        window.addEventListener('resize', () => { if (STATE.status === 'PLAYING') setupSlotTimerSVG(); adjustCentralLayout(); });
        updateModeButtons(STATE.currentModeKey);
    };

    /* --- „Çπ„É≠„Éº„É¢„Éº„Ç∑„Éß„É≥Ê©üËÉΩ (FERMATA AESTHETIC) --- */
    function initSlowMo() {
        const today = new Date().toLocaleDateString('ja-JP');
        const lastDate = localStorage.getItem('snow_sm_date');
        let left = parseInt(localStorage.getItem('snow_sm_left'), 10);
        if (lastDate !== today || isNaN(left)) {
            left = 3; localStorage.setItem('snow_sm_date', today); localStorage.setItem('snow_sm_left', 3);
        }
        STATE.chargesToday = left;
        renderSlowMoBtn();
    }
    
    function renderSlowMoBtn() {
        const btn = UI.btnSlowMo;
        const chargesContainer = $id('ts-charges');
        if(!btn || !chargesContainer) return;
        
        let html = '';
        if (STATE.chargesToday > 0) {
            // ÊÆã„Çä„ÅÆÊï∞„Å†„Åë ùÑê („Éï„Çß„É´„Éû„Éº„Çø) „ÇíË°®Á§∫
            // Êöñ„Åã„Åø„ÅÆ„ÅÇ„ÇãËâ≤„ÄÅÊû†Á∑ö„ÅÇ„Çä
            for(let i=0; i<STATE.chargesToday; i++) {
                html += '<span class="ts-charge-icon">ùÑê</span>';
            }
            btn.classList.remove('disabled', 'depleted');
        } else {
            // ‰Ωø„ÅÑÂàá„Å£„Åü„Çâ // (Cesura - „Ç´„Ç®„Çπ„Éº„É©)
            // Êû†Á∑öÊ∂àÂéª„ÄÅÂÜ∑„Åü„ÅÑËÉåÊôØ„ÄÅÂÜ∑„Åü„ÅÑ„Ç∞„É¨„Éº„ÅÆË®òÂè∑
            html = '<span class="ts-charge-icon used-cesura">//</span>';
            btn.classList.add('disabled', 'depleted');
        }
        chargesContainer.innerHTML = html;
    }
    
    function activateSlowMo() {
        // Áô∫ÂãïÊù°‰ª∂: „Éó„É¨„Ç§‰∏≠„Åã„Å§„ÄÅÊÆãÂºæ„ÅÇ„Çä„Åã„Å§„ÄÅÊó¢„Å´„Çπ„É≠„Éº‰∏≠„Åß„Å™„ÅÑ„Åì„Å®
        if (STATE.status !== 'PLAYING' || STATE.chargesToday <= 0) return;
        if (Date.now() < STATE.slowUntil) return; // Êó¢„Å´Áô∫Âãï‰∏≠„Å™„ÇâÁÑ°Ë¶ñ
        
        const now = Date.now();
        const DURATION = 13000; // 13Áßí

        STATE.slowUntil = now + DURATION;
        document.body.classList.add('slow-motion');
        
        // „Éú„Çø„É≥„Çí„É≠„ÉÉ„ÇØ (runningÁä∂ÊÖã)
        if(UI.btnSlowMo) UI.btnSlowMo.classList.add('running');
        
        STATE.chargesToday--;
        localStorage.setItem('snow_sm_left', STATE.chargesToday);
        renderSlowMoBtn(); // ÊÆãÊï∞Êõ¥Êñ∞
    }

    /* --- Ê©üËÉΩÈñ¢Êï∞Áæ§ --- */
    function adjustCentralLayout() {
        if (!UI.virtualKeyboard || !UI.tuteCentralMsg) return;
        const windowH = window.innerHeight;
        const kbH = UI.virtualKeyboard.offsetHeight;
        UI.tuteCentralMsg.style.top = `${(windowH - kbH) / 2 + 40}px`;
    }
    function initKeyLayout() {
        const saved = localStorage.getItem('snow_key_layout');
        const found = KB_SETTINGS.find(s => s.id === saved);
        STATE.currentKbLayout = found ? found.id : KB_SETTINGS[0].id;
        applyKeyLayout(STATE.currentKbLayout);
    }
    function toggleKeyLayout() {
        const currIdx = KB_SETTINGS.findIndex(s => s.id === STATE.currentKbLayout);
        STATE.currentKbLayout = KB_SETTINGS[(currIdx + 1) % KB_SETTINGS.length].id;
        localStorage.setItem('snow_key_layout', STATE.currentKbLayout);
        applyKeyLayout(STATE.currentKbLayout);
    }
    function applyKeyLayout(layoutId) {
        if(!UI.virtualKeyboard) return;
        const setting = KB_SETTINGS.find(s => s.id === layoutId);
        KB_SETTINGS.forEach(s => {
             UI.virtualKeyboard.classList.remove(s.layoutClass);
             if(UI.btnKeyLayoutToggle) UI.btnKeyLayoutToggle.classList.remove(s.btnClass);
        });
        UI.virtualKeyboard.classList.add(setting.layoutClass);
        if(UI.btnKeyLayoutToggle) {
            UI.btnKeyLayoutToggle.innerText = setting.label;
            UI.btnKeyLayoutToggle.classList.add(setting.btnClass);
        }
    }
    function animateKey(kVal) {
        const btn = KB.keys[kVal];
        if(btn && !btn.classList.contains('disabled')) {
            btn.classList.add('active-state');
            triggerRipple(btn);
            setTimeout(() => btn.classList.remove('active-state'), 100);
        }
    }
    function updateKeyboardLayoutForMode() {
        const mode = MODES[STATE.currentModeKey];
        const isMulti = (mode.type === 'EXT' || mode.type === 'HARD');
        if(KB.keys['0']) isMulti ? KB.keys['0'].classList.remove('disabled') : KB.keys['0'].classList.add('disabled');
        if(KB.keys['DEL']) isMulti ? KB.keys['DEL'].classList.remove('disabled') : KB.keys['DEL'].classList.add('disabled');
    }
    function currentRanksStore() { return STATE.saveData.ranks2D; }
    function isRankHigherOrEqual(current, target) { return current && RANK_ORDER.indexOf(current) <= RANK_ORDER.indexOf(target); }
    function getRankFromScore(score, modeName) {
        const th = MODES[modeName].rankThresholds;
        if(score >= th.god) return 'GOD'; if(score >= th.z) return 'Z'; if(score >= th.s) return 'S';
        if(score >= th.a) return 'A'; if(score >= th.b) return 'B'; if(score >= th.c) return 'C'; return 'D'; 
    }
    function openHowTo() { if(UI.howToModal) UI.howToModal.classList.add('active'); }
    function closeHowTo() { if(UI.howToModal) UI.howToModal.classList.remove('active'); }
    function updateLoginStreak() {
        const today = new Date().toLocaleDateString('ja-JP'); 
        const last = localStorage.getItem('snow_last_login_date');
        let streak = parseInt(localStorage.getItem('snow_login_streak')||'0', 10);
        if (last !== today) {
            const y = new Date(); y.setDate(y.getDate()-1);
            if (last === y.toLocaleDateString('ja-JP')) streak++; else streak = 1;
            localStorage.setItem('snow_last_login_date', today); localStorage.setItem('snow_login_streak', streak);
        } else { if(streak===0) streak=1; }
        if($id('login-streak-display')) $id('login-streak-display').innerText = 'üî•' + streak;
    }
    function setupSlotTimerSVG() {
        const c = UI.slot1; if(!c) return;
        if(c.querySelector('.slot-timer-svg')) c.querySelector('.slot-timer-svg').remove();
        const w = c.offsetWidth, h = c.offsetHeight;
        const ns = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(ns, "svg");
        svg.setAttribute("class", "slot-timer-svg"); svg.setAttribute("width", "100%"); svg.setAttribute("height", "100%"); svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
        svg.style.position = 'absolute'; svg.style.left = '0'; svg.style.top = '0';
        const cx = w/2;
        const pL = document.createElementNS(ns, "path"); pL.setAttribute("d", `M ${cx} ${h} L 0 ${h} L 0 0 L ${cx} 0`); pL.setAttribute("class", "timer-path"); pL.style.strokeWidth="8px";
        const pR = document.createElementNS(ns, "path"); pR.setAttribute("d", `M ${cx} ${h} L ${w} ${h} L ${w} 0 L ${cx} 0`); pR.setAttribute("class", "timer-path"); pR.style.strokeWidth="8px";
        svg.appendChild(pL); svg.appendChild(pR); c.appendChild(svg);
        UI.timerPathL = pL; UI.timerPathR = pR;
        pL.style.strokeDasharray = pL.getTotalLength(); pL.style.strokeDashoffset = 0;
        pR.style.strokeDasharray = pR.getTotalLength(); pR.style.strokeDashoffset = 0;
    }
    function updateTimerSVG(pct, color) {
        if (!UI.timerPathL) return;
        const offL = UI.timerPathL.getTotalLength() * (1-pct);
        const offR = UI.timerPathR.getTotalLength() * (1-pct);
        UI.timerPathL.style.strokeDashoffset=offL; UI.timerPathR.style.strokeDashoffset=offR;
        UI.timerPathL.style.stroke=color; UI.timerPathR.style.stroke=color;
    }
    function resetTimerVisuals() {
        if (!UI.timerPathL) return;
        UI.timerPathL.style.transition='none'; UI.timerPathR.style.transition='none';
        UI.timerPathL.style.strokeDashoffset=0; UI.timerPathR.style.strokeDashoffset=0;
        void UI.timerPathL.offsetWidth;
        UI.timerPathL.style.transition='stroke 0.1s linear'; UI.timerPathR.style.transition='stroke 0.1s linear';
    }
    function updateThemeClass() {
        if(!UI.appWrapper) return;
        UI.appWrapper.classList.remove('theme-easy','theme-normal','theme-hard','theme-extreme');
        UI.appWrapper.classList.add('theme-'+STATE.currentModeKey.toLowerCase());
    }
    function handleTapToStart() {
        if (STATE.status !== 'IDLE' || STATE.isInputBlocked) return;
        if (UI.tuteStartBtn) UI.tuteStartBtn.style.display = 'none';
        if (UI.tuteModeSelect) { UI.tuteModeSelect.style.display = 'flex'; if (UI.btnHowToBottom) UI.btnHowToBottom.style.display = 'flex'; checkUnlocks(); }
        adjustCentralLayout();
    }
    function toggleDimensionMode() {
        if (STATE.status !== 'IDLE' || STATE.isInputBlocked) return;
        STATE.isRandomMode = !STATE.isRandomMode;
        updateToggleButtonText(); resetToIdle();
    }
    function updateToggleButtonText() {
        if(STATE.isRandomMode) { UI.btnModeToggle.classList.add('random-on'); UI.btnModeToggle.innerHTML = `<span class="check">‚òë</span><span class="label">RANDOM</span>`; } 
        else { UI.btnModeToggle.classList.remove('random-on'); UI.btnModeToggle.innerHTML = `<span class="check">‚òê</span><span class="label">RANDOM</span>`; }
    }
    function resetToIdle() {
        STATE.status = 'IDLE'; STATE.isInputBlocked = false;
        UI.appWrapper.classList.remove('showing-result');
        STATE.isExtreme = (STATE.currentModeKey === 'EXTREME');
        updateThemeClass();
        if(UI.resultModal) UI.resultModal.classList.remove('show');
        if(UI.virtualKeyboard) UI.virtualKeyboard.style.visibility = 'visible';
        if(UI.slot1 && UI.slot1.querySelector('.slot-timer-svg')) UI.slot1.querySelector('.slot-timer-svg').remove();
        if(UI.slot1) { UI.slot1.style.border = '4px solid rgba(255,255,255,0.1)'; UI.slot1.style.borderBottom = 'none'; }
        UI.failShutter.classList.remove('active'); UI.failShutter.style.display = 'flex';
        UI.victoryShutter.classList.remove('active'); UI.victoryShutter.style.transition='none'; UI.victoryShutter.style.height='0%';
        void UI.victoryShutter.offsetHeight; setTimeout(() => { UI.victoryShutter.style.transition='height 0.4s cubic-bezier(0.16,1,0.3,1)'; }, 50);
        UI.tutorialOverlay.classList.add('active'); UI.hudModeLabel.classList.remove('show');
        $qsa('.eval-effect').forEach(e => e.remove());
        updateToggleButtonText(); UI.btnModeToggle.classList.remove('disabled');
        
        // ‚òÖ„ÉÑ„Éº„É´„Éê„ÉºÂà∂Âæ°: IDLEÊôÇ„ÅØÂàáÊõø„Éú„Çø„É≥„ÅÆ„Åø
        if(UI.btnKeyLayoutToggle) UI.btnKeyLayoutToggle.style.display = 'flex';
        if(UI.btnSlowMo) {
            UI.btnSlowMo.style.display = 'none';
            UI.btnSlowMo.classList.remove('running'); // „É™„Çª„ÉÉ„ÉàÊôÇ„Å´„É≠„ÉÉ„ÇØ„ÇÇËß£Èô§
        }
        
        if(UI.btnModeToggle) UI.btnModeToggle.style.display = 'flex';
        if(UI.btnHowToOpening) UI.btnHowToOpening.style.display = 'flex';
        DomPool.clearView(UI.view1); DomPool.clearView(UI.view2); DomPool.clearView(UI.view3);
        checkUnlocks();
        $qsa('.mode-btn').forEach(b => { b.style.transform='skewX(-15deg)'; setTimeout(() => b.style.transform='', 50); });
        updateModeButtons(STATE.currentModeKey);
        UI.bottomUi.classList.remove('bottom-ui-dimmed');
        UI.tuteBigMsg.style.display = 'none'; UI.tuteBigMsg.classList.remove('pop');
        closeHowTo();
        if (UI.btnHowToOpening) UI.btnHowToOpening.style.display = 'flex';
        if (UI.btnHowToBottom) UI.btnHowToBottom.style.display = 'none';
        if (!STATE.hasPlayedOnce) {
            if (UI.tuteStartBtn) UI.tuteStartBtn.style.display = 'inline-flex';
            if (UI.tuteModeSelect) UI.tuteModeSelect.style.display = 'none';
        } else {
            if (UI.btnHowToOpening) UI.btnHowToOpening.style.display = 'flex';
            if (UI.tuteStartBtn) UI.tuteStartBtn.style.display = 'none';
            if (UI.tuteModeSelect) UI.tuteModeSelect.style.display = 'flex';
        }
        updateKeyboardLayoutForMode(); adjustCentralLayout();
    }
    function checkUnlocks() {
        const r = currentRanksStore();
        const bestEasyCH = STATE.saveData.bestEasyCH || 0;
        const lockedN = !(isRankHigherOrEqual(r['EASY'],'A') || bestEasyCH>=10000);
        const lockedH = !(isRankHigherOrEqual(r['EASY'],'S') || bestEasyCH>=10000 || isRankHigherOrEqual(r['NORMAL'],'A'));
        const lockedE = !(bestEasyCH>=MODES['EASY'].rankThresholds.z || isRankHigherOrEqual(r['NORMAL'],'S') || isRankHigherOrEqual(r['HARD'],'A'));
        const setL = (sel, l) => $qsa(sel).forEach(b => l ? b.classList.add('locked') : b.classList.remove('locked'));
        setL('.mode-easy', false); setL('.mode-normal', lockedN); setL('.mode-hard', lockedH); setL('.mode-extreme', lockedE);
    }
    function isModeLocked(k) {
        const r = currentRanksStore(); const best = STATE.saveData.bestEasyCH || 0;
        if(k==='EASY') return false;
        if(k==='NORMAL') return !(isRankHigherOrEqual(r['EASY'],'A') || best>=10000);
        if(k==='HARD') return !(isRankHigherOrEqual(r['EASY'],'S') || best>=10000 || isRankHigherOrEqual(r['NORMAL'],'A'));
        if(k==='EXTREME') return !(best>=MODES['EASY'].rankThresholds.z || isRankHigherOrEqual(r['NORMAL'],'S') || isRankHigherOrEqual(r['HARD'],'A'));
        return true;
    }
    function handleModeSelect(k, btn) {
        if(STATE.status!=='IDLE' || STATE.isInputBlocked || isModeLocked(k)) return;
        if(btn) triggerRipple(btn);
        STATE.currentModeKey = k; STATE.isExtreme = (k==='EXTREME');
        updateThemeClass(); updateModeButtons(k); startCountdown();
    }
    function updateModeButtons(activeKey) {
        $qsa('.mode-btn').forEach(btn => {
            btn.classList.remove('active-mode');
            if(btn.classList.contains('mode-'+activeKey.toLowerCase())) btn.classList.add('active-mode');
        });
    }
    function startCountdown() {
        STATE.status = 'COUNTDOWN'; STATE.isInputBlocked = true; STATE.hasPlayedOnce = true;
        UI.btnModeToggle.classList.add('disabled');
        // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥‰∏≠„ÅØ„ÉÑ„Éº„É´„Éê„ÉºË¶ÅÁ¥†„ÇíÈö†„Åô
        if(UI.btnKeyLayoutToggle) UI.btnKeyLayoutToggle.style.display = 'none';
        if(UI.btnSlowMo) UI.btnSlowMo.style.display = 'none';
        if(UI.btnModeToggle) UI.btnModeToggle.style.display = 'none';
        if(UI.btnHowToOpening) UI.btnHowToOpening.style.display = 'none';
        UI.bottomUi.classList.add('bottom-ui-dimmed');
        if(UI.btnHowToBottom) UI.btnHowToBottom.style.display = 'none';
        const seq = ['READY', '3', '2', '1']; let idx = 0;
        UI.tuteBigMsg.style.display = 'block'; UI.tuteBigMsg.innerText = seq[0]; UI.tuteBigMsg.classList.add('pop');
        if (UI.tuteStartBtn) UI.tuteStartBtn.style.display = 'none';
        if (UI.tuteModeSelect) UI.tuteModeSelect.style.display = 'none';
        const mode = MODES[STATE.currentModeKey];
        UI.hudModeLabel.innerText = `${STATE.currentModeKey}${STATE.isRandomMode ? ' [R]' : ''}`;
        UI.hudModeLabel.style.borderColor = mode.color; UI.hudModeLabel.style.color = mode.color; UI.hudModeLabel.classList.add('show');
        adjustCentralLayout();
        const t = setInterval(() => {
            idx++; UI.tuteBigMsg.classList.remove('pop'); void UI.tuteBigMsg.offsetWidth;
            if(idx < seq.length) { UI.tuteBigMsg.innerText = seq[idx]; UI.tuteBigMsg.classList.add('pop'); }
            else { clearInterval(t); UI.tutorialOverlay.classList.remove('active'); UI.tuteBigMsg.style.display = 'none'; startGame(); }
        }, 300);
    }
    function startGame() {
        STATE.status = 'PLAYING'; STATE.isInputBlocked = false; STATE.score = 0; STATE.questionCount = 0; STATE.generatedCount = 0;
        STATE.totalPlayTime = 0; STATE.missedLog = []; STATE.queue = []; STATE.currentInput = '';
        STATE.statsDetail = { marvelous: {count:0,time:0}, excellent: {count:0,time:0}, great: {count:0,time:0}, good: {count:0,time:0}, ok: {count:0,time:0} };
        STATE.randomAtPlay = STATE.isRandomMode; STATE.lastCount = null; STATE.lastShapeSig = null; STATE.consecutiveCountValue = 0;
        if(UI.slot1) UI.slot1.style.border = 'none';
        
        STATE.slowUntil = 0; document.body.classList.remove('slow-motion');
        
        // ‚òÖÊà¶Èóò„É¢„Éº„ÉâUI
        if(UI.btnKeyLayoutToggle) UI.btnKeyLayoutToggle.style.display = 'none';
        if(UI.btnSlowMo) { 
            UI.btnSlowMo.style.display = 'flex'; 
            UI.btnSlowMo.classList.remove('running'); // „Ç≤„Éº„É†ÈñãÂßãÊôÇ„ÅØ„É≠„ÉÉ„ÇØËß£Èô§
            renderSlowMoBtn(); 
        }
        
        setupSlotTimerSVG(); addQueueItem(); addQueueItem(); addQueueItem();
        STATE.current = STATE.queue.shift(); renderQueue(); resetTimerVisuals();
        
        STATE.elapsedTime = 0;
        STATE.lastTick = Date.now();
        if(STATE.rafId) cancelAnimationFrame(STATE.rafId);
        updateKeyboardLayoutForMode(); gameLoop();
    }
    
    function gameLoop() {
        if(STATE.status !== 'PLAYING') return;
        const now = Date.now();
        const rawDelta = (now - STATE.lastTick) / 1000;
        STATE.lastTick = now;

        // „Çπ„É≠„ÉºÂá¶ÁêÜ (0.2ÂÄçÈÄü)
        let timeFactor = 1.0;
        if (now < STATE.slowUntil) {
            timeFactor = 0.2; 
        } else {
            // „Çπ„É≠„ÉºÁµÇ‰∫ÜÂá¶ÁêÜ
            if (document.body.classList.contains('slow-motion')) {
                document.body.classList.remove('slow-motion');
                // „É≠„ÉÉ„ÇØËß£Èô§
                if(UI.btnSlowMo) UI.btnSlowMo.classList.remove('running');
            }
        }

        const effectiveDelta = rawDelta * timeFactor;
        STATE.elapsedTime += effectiveDelta;
        STATE.totalPlayTime += effectiveDelta; 

        const mode = MODES[STATE.currentModeKey];
        if (STATE.elapsedTime > mode.time) {
            handleMiss("TIME", "-", STATE.current.count);
            return;
        }

        const pct = Math.max(0, 1 - (STATE.elapsedTime / mode.time));
        const j = mode.judgments; let c = '#a0a0a0';
        if (STATE.elapsedTime <= j.marv) c = '#fff200'; else if (STATE.elapsedTime <= j.exc) c = '#00ffff'; else if (STATE.elapsedTime <= j.great) c = '#00ff2a';
        else if (j.good && STATE.elapsedTime <= j.good) c = '#ffaa00'; else if (j.ok && STATE.elapsedTime <= j.ok) c = '#b0b0b0'; else c = '#ff0033';
        
        updateTimerSVG(pct, c);
        STATE.rafId = requestAnimationFrame(gameLoop);
    }

    function processInput(val) { if(!STATE.current || STATE.isInputBlocked) return; checkAnswer(val); }
    function processInputExtreme(key) {
        if(!STATE.current || STATE.isInputBlocked) return;
        if (key === 'DEL') { STATE.currentInput = STATE.currentInput.slice(0, -1); return; }
        const tLen = String(STATE.current.count).length;
        if (STATE.currentInput.length < tLen) STATE.currentInput += key;
        if (STATE.currentInput.length === tLen) { checkAnswer(parseInt(STATE.currentInput, 10)); STATE.currentInput = ''; }
    }
    function checkAnswer(val) {
        const delta = STATE.elapsedTime;
        if(val === STATE.current.count) {
            const eff = Math.max(delta, CONFIG.capPerItemSec);
            const mode = MODES[STATE.currentModeKey]; const j = mode.judgments;
            let k="miss", l="MISS";
            if (delta <= j.marv) { k="marvelous"; l="MARVELOUS"; } else if (delta <= j.exc) { k="excellent"; l="EXCELLENT"; }
            else if (delta <= j.great) { k="great"; l="GREAT"; } else if (j.good && delta <= j.good) { k="good"; l="GOOD"; }
            else if (j.ok && delta <= j.ok) { k="ok"; l="OK"; } else { handleMiss("SLOW", val, STATE.current.count); return; }
            STATE.statsDetail[k].count++; STATE.statsDetail[k].time += eff;
            triggerEvalEffect(l); flashSlot(l);
            if(STATE.questionCount >= mode.count - 1) { DomPool.clearView(UI.view1); gameOver("FINISHED"); } else nextQuestion();
        } else handleMiss("TYPE", val, STATE.current.count);
    }
    function flashSlot(grade) {
        const c = UI.slot1; if(c.querySelector('.slot-flash-overlay')) c.querySelector('.slot-flash-overlay').remove();
        const el = document.createElement('div'); el.className = 'slot-flash-overlay';
        let cls = 'flash-ok';
        if(grade==='MARVELOUS') cls='flash-exc'; else if(grade==='EXCELLENT') cls='flash-perf';
        else if(grade==='GREAT') cls='flash-grt'; else if(grade==='GOOD') cls='flash-good'; else if(grade==='MISS') cls='flash-miss';
        c.classList.remove('flash-exc','flash-perf','flash-grt','flash-good','flash-ok','flash-miss');
        c.classList.add(cls); c.appendChild(el);
    }
    function handleMiss(res, inp, ans) {
        STATE.missedLog.push({ input:inp, answer:ans, shape:STATE.is3DMode?STATE.current.shape.map(r=>[...r]):[...STATE.current.shape], layout:STATE.current.shape._rndPositions?STATE.current.shape._rndPositions.map(p=>({x:p.x,y:p.y})):null, mode:STATE.currentModeKey, is3D:STATE.is3DMode, isRandom:STATE.randomAtPlay });
        flashSlot("MISS"); gameOver(res==="TIME"?"TIME OVER":res==="SLOW"?"TOO SLOW":"NICE TRY");
    }
    function nextQuestion() {
        STATE.questionCount++; if(STATE.queue.length < 3) addQueueItem();
        STATE.current = STATE.queue.shift(); renderQueue(); resetTimerVisuals();
        STATE.elapsedTime = 0; STATE.currentInput = '';
    }
    function triggerEvalEffect(txt) {
        $qsa('.eval-effect').forEach(e => e.remove());
        const el = document.createElement('div'); el.className = 'eval-effect'; el.innerText = txt;
        el.style.color = (txt==="MARVELOUS"?"var(--g-exc)":txt==="EXCELLENT"?"var(--g-perf)":txt==="GREAT"?"var(--g-grt)":txt==="GOOD"?"var(--g-good)":"#fff");
        document.body.appendChild(el); setTimeout(() => { if(el.parentNode) el.parentNode.removeChild(el); }, 1000);
    }
    function addQueueItem() {
        const mk = STATE.currentModeKey; const mode = MODES[mk];
        if(STATE.generatedCount >= mode.count) { STATE.queue.push({count:null,shape:[]}); return; }
        let n;
        for (let i=0; i<2000; i++) {
            if (mk === 'EASY' || mk === 'NORMAL' || mk === 'HARD') n = BagSystem.getNext(mk);
            else { 
                const q = STATE.generatedCount+1; 
                let min,max; 
                if(q===1){min=13;max=16;}else if(q<=3){min=17;max=22;}else if(q<=5){min=23;max=29;}else if(q<=7){min=30;max=35;}else if(q<=9){min=36;max=39;}else{min=40;max=42;} 
                n = Math.floor(min + Math.random()*(max-min+1)); 
            }
            let maxH=(mk==='EASY'?3:mk==='NORMAL'?5:mk==='HARD'?7:9), cols=(mk==='EASY'||mk==='NORMAL'?3:mk==='HARD'?4:9);
            if(mk==='HARD' && STATE.queue.length>0 && STATE.queue[STATE.queue.length-1].shape.length===5) cols=4; else if(mk==='HARD') cols=Math.random()<0.5?4:5;
            let sData = STATE.is3DMode ? generateStadium3D_Strict(n,cols,maxH) : generateShape2D_Connected(n,cols,maxH);
            let tCount = 0; if(STATE.is3DMode) sData.forEach(r=>r.forEach(h=>tCount+=h)); else sData.forEach(h=>tCount+=h);
            if(tCount===0 && n>0) tCount=1;
            const sig = JSON.stringify(sData);
            if(STATE.lastShapeSig && sig===STATE.lastShapeSig) continue;
            if((mk==='EXTREME') && (STATE.lastCount===tCount && STATE.consecutiveCountValue>=2)) continue;
            if(STATE.lastCount===tCount) STATE.consecutiveCountValue++; else STATE.consecutiveCountValue=1;
            STATE.lastCount=tCount; STATE.lastShapeSig=sig; STATE.queue.push({count:tCount, shape:sData}); break;
        }
        STATE.generatedCount++;
    }
    function generateShape2D_Connected(n, c, mh) {
        const a = new Array(c).fill(0); a[Math.floor(c/2)]++; let p=1, f=0;
        while(p<n) {
            let cand=[]; for(let i=0; i<c; i++) { if(a[i]<mh && (a[i]>0 || (i>0&&a[i-1]>0) || (i<c-1&&a[i+1]>0))) cand.push(i); }
            if(cand.length===0) for(let i=0;i<c;i++)if(a[i]<mh)cand.push(i);
            if(cand.length===0) break;
            a[cand[Math.floor(Math.random()*cand.length)]]++; p++; f++; if(f>100) break;
        } return a;
    }
    function generateStadium3D_Strict(n, s, mh) {
        const g=Array(s).fill(0).map(()=>Array(s).fill(0)); let p=0,f=0;
        while(p<n) {
            let cand=[];
            for(let x=0;x<s;x++)for(let z=0;z<s;z++){ const h=g[x][z]; if(h<mh && !(x<s-1 && h+1>g[x+1][z]) && !(z<s-1 && h+1>g[x][z+1])) cand.push({x,z}); }
            if(cand.length===0) break;
            const k=cand[Math.floor(Math.random()*cand.length)]; g[k.x][k.z]++; p++; f++; if(f>100) break;
        } return g;
    }
    function renderQueue() {
        renderShape(UI.view1, STATE.current?STATE.current.shape:[]); renderShape(UI.view2, STATE.queue[0]?STATE.queue[0].shape:[]); renderShape(UI.view3, STATE.queue[1]?STATE.queue[1].shape:[]);
    }
    function renderShape(el, d) {
        if(!el) return; DomPool.clearView(el); if(!d) return;
        const mc = 'mode-'+STATE.currentModeKey.toLowerCase();
        if(STATE.is3DMode) render3D(el,d,mc); else render2D(el,Array.isArray(d[0])?d.flat().filter(h=>h>0):d,mc,STATE.randomAtPlay);
    }
    function render2D(el, arr, mc, rnd) {
        const t = Array.isArray(arr)?arr.reduce((a,b)=>a+b,0):0; if(t<=0) return;
        if(rnd) {
            const c = DomPool.get('cluster'); c.className='cluster-container random-layout'; el.appendChild(c);
            let pos = arr._rndPositions || [];
            if(pos.length!==t) {
                pos=[]; const used=[]; const r=el.getBoundingClientRect(), W=r.width||window.innerWidth, H=r.height||(window.innerHeight*0.5), S=Math.min(window.innerWidth*0.075,30);
                for(let i=0; i<t; i++) {
                    let best={pct:{x:50,y:50},px:{l:0,t:0,r:0,b:0}};
                    for(let k=0; k<200; k++) {
                        const xp=6+Math.random()*88, yp=28+Math.random()*64, xPx=(xp/100)*W, yPx=(yp/100)*H;
                        const l=xPx-S/2, tt=yPx-S/2, rr=l+S, bb=tt+S;
                        if(!used.some(u=>!(rr<=u.px.l || l>=u.px.r || bb<=u.px.t || tt>=u.px.b))) { best={pct:{x:xp,y:yp},px:{l:l,t:tt,r:rr,b:bb}}; break; }
                    } used.push(best); pos.push(best.pct);
                } arr._rndPositions = pos;
            }
            pos.forEach(p => { const b=DomPool.get('block'); b.className='block '+mc+' block-random'; b.style.left=p.x+'%'; b.style.top=p.y+'%'; b.style.transform='translate(-50%,-50%)'; c.appendChild(b); });
        } else {
            const c=DomPool.get('cluster'); c.className='cluster-container';
            arr.forEach(h=>{ 
                if(h===0)return; 
                const col=DomPool.get('column'); col.className='block-column'; 
                for(let i=0;i<h;i++){ const b=DomPool.get('block'); b.className='block '+mc; col.appendChild(b); } 
                c.appendChild(col); 
            });
            el.appendChild(c);
        }
    }
    function render3D(el, g, mc) {
        const c=DomPool.get('cluster'); c.className='cluster-container real-3d';
        const bs=parseInt(getComputedStyle(document.body).getPropertyValue('--block-size-3d')), off=(g.length*bs)/2 - bs/2;
        let cubes=[];
        g.forEach((r,x)=>{ r.forEach((h,z)=>{ if(h===0)return; for(let y=0;y<h;y++) {
            const cube = DomPool.get('cube'); cube.className = 'cube '+mc;
            cube.style.transform=`translateX(${(x*bs)-off}px) translateY(${-(y*bs)}px) translateZ(${(z*bs)-off}px)`;
            cubes.push({html:cube, k:x-z}); 
        }}); });
        cubes.sort((a,b)=>a.k-b.k).forEach(o=>c.appendChild(o.html)); el.appendChild(c);
    }
    function triggerRipple(el) { if(!el)return; el.classList.remove('ripple'); void el.offsetWidth; el.classList.add('ripple'); setTimeout(()=>el.classList.remove('ripple'),350); }
    function gameOver(res) {
        if(STATE.status==='GAMEOVER') return; STATE.status='GAMEOVER'; STATE.isInputBlocked=true; if(STATE.rafId)cancelAnimationFrame(STATE.rafId);
        $qsa('.kb-key').forEach(k=>k.classList.remove('active-state'));
        if(res==="FINISHED") UI.victoryShutter.classList.add('active'); else UI.failShutter.classList.add('active');
        document.body.classList.remove('slow-motion'); 
        const ac=(res==='FINISHED')?MODES[STATE.currentModeKey].count:STATE.questionCount;
        const ts=Math.max(0.1, STATE.totalPlayTime); let ch=Math.floor((ac/ts)*3600); if(ch>CONFIG.capCh) ch=CONFIG.capCh;
        
        const dat={ modeName:STATE.currentModeKey, is3D:STATE.is3DMode, isRandom:STATE.randomAtPlay, score:ch, totalTime:ts, count:ac, reason:res, missedLog:[...STATE.missedLog], statsDetail:JSON.parse(JSON.stringify(STATE.statsDetail)), isNewRecord:false, unlockEvent:null, rank:'F' };
        
        const wNL=isModeLocked('NORMAL'), wHL=isModeLocked('HARD'), wEL=isModeLocked('EXTREME');
        if(res==="FINISHED") {
            dat.rank=getRankFromScore(ch, STATE.currentModeKey);
            const rs=currentRanksStore(), old=rs[STATE.currentModeKey], ni=RANK_ORDER.indexOf(dat.rank), oi=old?RANK_ORDER.indexOf(old):99;
            if(ni<oi) rs[STATE.currentModeKey]=dat.rank;
            if(ch>(STATE.saveData.modeScores[STATE.currentModeKey]||0)) { STATE.saveData.modeScores[STATE.currentModeKey]=ch; dat.isNewRecord=true; }
            if(STATE.currentModeKey==='EASY' && ch>(STATE.saveData.bestEasyCH||0)) STATE.saveData.bestEasyCH=ch;
            if(ch>(STATE.saveData.bestCH||0)) STATE.saveData.bestCH=ch;
            
            if(wEL && !isModeLocked('EXTREME')) dat.unlockEvent='EXTREME';
            else if(wHL && !isModeLocked('HARD')) dat.unlockEvent='HARD';
            else if(wNL && !isModeLocked('NORMAL')) dat.unlockEvent='NORMAL';
        }
        STATE.history.push(dat); STATE.historyIndex=STATE.history.length-1; setTimeout(()=>showHistoryResult(STATE.historyIndex), 1000);
    }
    function changeHistory(d) { const n=STATE.historyIndex+d; if(n>=0 && n<STATE.history.length) { STATE.historyIndex=n; showHistoryResult(n); } }
    function showHistoryResult(idx) {
        STATE.isInputBlocked=false; const d=STATE.history[idx]; UI.virtualKeyboard.style.visibility='hidden';
        if(UI.slot1 && UI.slot1.querySelector('.slot-timer-svg')) UI.slot1.querySelector('.slot-timer-svg').remove(); if(UI.slot1) UI.slot1.style.border='none';
        UI.failShutter.style.display='none';
        if(UI.histPrev) { UI.histPrev.disabled=(idx===0); UI.histPrev.style.opacity=(idx===0)?'0':'1'; }
        if(UI.histNext) { UI.histNext.disabled=(idx===STATE.history.length-1); UI.histNext.style.opacity=(idx===STATE.history.length-1)?'0':'1'; }
        
        const mLabel=d.modeName; UI.resModeLabel.innerText=d.isRandom?`${mLabel} (RND)`:mLabel;
        const mc=MODES[d.modeName].color; UI.resModeLabel.style.color=mc; UI.resModeLabel.style.borderColor=mc;
        let rc='rank-f', rt=d.rank, nt=false;
        if(d.rank==='GOD') rc='rank-god'; else if(d.rank==='Z') rc='rank-z'; else if(d.rank==='S') rc='rank-s'; else if(d.rank==='A') rc='rank-a'; else if(d.rank==='B') rc='rank-b'; else if(d.rank==='C') rc='rank-c'; else if(d.rank==='F') { rc='rank-nicetry'; rt="NICE TRY"; nt=true; }
        UI.resRankChar.innerText=rt; UI.resRankChar.className='rank-char '+rc;
        UI.resRankLabelText.style.display = nt ? 'none' : 'block';
        
        UI.resultCardContainer.className='result-card'; $qsa('.particle-fx').forEach(p=>p.remove());
        if(d.rank==='GOD') { UI.resultCardContainer.classList.add('bg-god'); for(let i=0;i<40;i++){const p=document.createElement('div');p.className='god-particle particle-fx';p.style.left=Math.random()*100+'%';p.style.height=(50+Math.random()*150)+'px';p.style.animationDuration=(2+Math.random()*3)+'s';p.style.animationDelay=(Math.random()*5)+'s';UI.resultCardContainer.appendChild(p);} }
        else if(d.rank==='Z') { UI.resultCardContainer.classList.add('bg-z'); for(let i=0;i<60;i++){const p=document.createElement('div');p.className='z-particle particle-fx';p.style.left=Math.random()*100+'%';const s=2+Math.random()*5;p.style.width=s+'px';p.style.height=s+'px';p.style.animationDuration=(3+Math.random()*5)+'s';p.style.animationDelay=(Math.random()*8)+'s';UI.resultCardContainer.appendChild(p);} }
        else UI.resultCardContainer.classList.add('bg-'+d.rank.toLowerCase());
        
        if(nt) { UI.resMsg.style.display='none'; } else { UI.resMsg.innerText=(d.reason==="FINISHED")?"":d.reason; UI.resMsg.style.display='block'; UI.resMsg.className=""; if(d.reason==="NICE TRY"||d.reason==="TOO SLOW")UI.resMsg.classList.add("res-msg-nice"); else if(d.reason==="TIME OVER")UI.resMsg.classList.add("res-msg-platinum"); }
        UI.resStatusMsg.classList.remove('show'); UI.resStatusMsg.innerText=''; UI.resUnlockWrapper.classList.remove('show'); UI.resUnlockWrapper.innerHTML='';
        if(d.reason==="FINISHED") {
            if(d.unlockEvent) { UI.resUnlockWrapper.innerHTML=`<div class="unlock-badge mode-${d.unlockEvent.toLowerCase()}"><div class="main-text">UNLOCKED</div><div class="sub-text">${d.unlockEvent}</div></div>`; UI.resUnlockWrapper.classList.add('show'); }
            else { UI.resStatusMsg.innerText=""; }
        }
        UI.newRecordBadge.classList[d.isNewRecord?'add':'remove']('show');
        const avgT=(d.totalTime/d.count).toFixed(2);
        let nxt=""; 
        if(d.reason==='FINISHED') {
             const ri=RANK_ORDER.indexOf(d.rank);
             if(ri>0) {
                 const nr=RANK_ORDER[ri-1], map={GOD:'god',Z:'z',S:'s',A:'a',B:'b',C:'c'}, th=MODES[d.modeName].rankThresholds[map[nr]];
                 if(th) nxt=`<div class="next-rank-line">NEXT RANK ${nr==='GOD'||nr==='Z'?'???':nr}: +${(Math.max(0,th-d.score)).toLocaleString()} ch</div>`;
             } else nxt=`<div class="next-rank-line">MAX RANK</div>`;
        }
        UI.resTotalBox.innerHTML = d.score>0 ? `<span class="total-label">TOTAL SCORE</span>${Number(d.score).toLocaleString()} <span style="font-size:16px;">ch</span><span class="total-avg-label"><span class="avg-text">AVG TIME</span><span class="avg-value">${avgT}s</span></span>${nxt}` : `<span class="total-label">TOTAL SCORE</span>0 <span style="font-size:16px;">ch</span>`;
        
        UI.detailTableBody.innerHTML='';
        [{k:'marvelous',l:'MARVELOUS',c:'var(--g-exc)'},{k:'excellent',l:'EXCELLENT',c:'var(--g-perf)'},{k:'great',l:'GREAT',c:'var(--g-grt)'},{k:'good',l:'GOOD',c:'var(--g-good)'},{k:'ok',l:'OK',c:'var(--g-ok)'}].forEach(g=>{
            const i=d.statsDetail[g.k];
            if(i&&i.count>0) {
                const a=(i.time/i.count).toFixed(2);
                let ls=Math.floor((1/Math.max(CONFIG.capPerItemSec,i.time/i.count))*3600); if(ls>CONFIG.capCh)ls=CONFIG.capCh;
                const tr=document.createElement('tr'); tr.innerHTML=`<td class="dt-grade" style="color:${g.c}">${g.l}</td><td class="dt-count">${i.count}</td><td class="dt-avg">${a}s</td><td class="dt-score">${ls.toLocaleString()} <span class="dt-sub">ch</span></td>`;
                UI.detailTableBody.appendChild(tr);
            }
        });
        
        UI.missItemsRow.innerHTML='';
        if(d.missedLog.length>0) {
            UI.missLog.style.display='flex';
            d.missedLog.forEach(m=>{
                const r=document.createElement('div'); r.className='feedback-row';
                const b=document.createElement('div'); b.className='fb-body';
                const i=document.createElement('div'); i.className='fb-body-inner'+(m.is3D?' fb-3d':' fb-2d')+(m.mode==='EXTREME'?' fb-extreme':'');
                if(m.layout && Array.isArray(m.shape)) m.shape._rndPositions=m.layout.map(p=>({x:p.x,y:p.y}));
                renderShape(i,m.shape); 
                b.appendChild(i);
                const f=document.createElement('div'); f.className='fb-footer'; f.innerHTML=`<span class="fb-lbl">INP</span><span class="fb-val-wrong">${m.input}</span> <span class="fb-lbl">ANS</span><span class="fb-val-correct">${m.answer}</span>`;
                r.appendChild(b); r.appendChild(f); UI.missItemsRow.appendChild(r);
            });
        } else UI.missLog.style.display='none';
        
        UI.appWrapper.classList.add('showing-result');
        if(UI.resultModal) UI.resultModal.classList.add('show');
        UI.bottomUi.classList.remove('bottom-ui-dimmed');
    }
</script>
</body>
</html>